<p>--======================================================================</p><p>--在服务器A上执行</p><p>--======================================================================</p><p>--Step 1</p><p>--======================================================================</p><p>--========================================================================</p><p>--Create endpoint with windows authentication</p><p>--========================================================================</p><p>USE master;</p><p>GO</p><p>IF EXISTS (SELECT * FROM master.sys.endpoints</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE name = N&#39;InstTargetEndpoint&#39;)</p><p>&nbsp; &nbsp; &nbsp;DROP ENDPOINT InstTargetEndpoint;</p><p>GO</p><p>CREATE ENDPOINT InstTargetEndpoint</p><p>STATE = STARTED</p><p>AS TCP ( LISTENER_PORT = 4022 )</p><p>FOR SERVICE_BROKER (AUTHENTICATION = WINDOWS );</p><p>GO</p><p>--========================================================================</p><p>--Create traget database InstTargetDB</p><p>--========================================================================</p><p>USE master;</p><p>GO</p><p>IF EXISTS (SELECT * FROM sys.databases</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE name = N&#39;InstTargetDB&#39;)</p><p>&nbsp; &nbsp; &nbsp;DROP DATABASE InstTargetDB;</p><p>GO</p><p>CREATE DATABASE InstTargetDB;</p><p>GO</p><p>USE InstTargetDB;</p><p>GO</p><p>CREATE MASTER KEY</p><p>&nbsp; &nbsp; &nbsp; &nbsp;ENCRYPTION BY PASSWORD = N&#39;Auto@sql&#39;;</p><p>GO</p><p>CREATE USER TargetUser WITHOUT LOGIN;</p><p>GO</p><p>--======================================================================================</p><p>--Create certification and backup it</p><p>--======================================================================================</p><p>USE InstTargetDB</p><p>GO</p><p>CREATE CERTIFICATE InstTargetCertificate&nbsp;</p><p>&nbsp; &nbsp; &nbsp;AUTHORIZATION TargetUser</p><p>&nbsp; &nbsp; &nbsp;WITH SUBJECT = &#39;Target Certificate&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EXPIRY_DATE = N&#39;12/31/2012&#39;;</p><p><br/></p><p>BACKUP CERTIFICATE InstTargetCertificate</p><p>&nbsp; TO FILE =&nbsp;</p><p>N&#39;\\Ms-wengao-02\cert\InstTargetCertificate.cer&#39;;</p><p>GO</p><p><br/></p><p>--======================================================================================</p><p>--Create message type,contract,queue,services</p><p>--======================================================================================</p><p>USE InstTargetDB</p><p>GO</p><p>CREATE MESSAGE TYPE [//BothDB/2InstSample/RequestMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp;VALIDATION = WELL_FORMED_XML;</p><p>CREATE MESSAGE TYPE [//BothDB/2InstSample/ReplyMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp;VALIDATION = WELL_FORMED_XML;</p><p>GO</p><p>CREATE CONTRACT [//BothDB/2InstSample/SimpleContract]</p><p>&nbsp; &nbsp; &nbsp; ([//BothDB/2InstSample/RequestMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SENT BY INITIATOR,</p><p>&nbsp; &nbsp; &nbsp; &nbsp;[//BothDB/2InstSample/ReplyMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SENT BY TARGET</p><p>&nbsp; &nbsp; &nbsp; );</p><p>GO</p><p>CREATE QUEUE InstTargetQueue;</p><p>GO</p><p>CREATE SERVICE [//TgtDB/2InstSample/TargetService]</p><p>&nbsp; &nbsp; &nbsp; &nbsp;AUTHORIZATION TargetUser</p><p>&nbsp; &nbsp; &nbsp; &nbsp;ON QUEUE InstTargetQueue</p><p>&nbsp; &nbsp; &nbsp; &nbsp;([//BothDB/2InstSample/SimpleContract]);</p><p>GO</p><p>--===================================================================================</p><p>--Step 3</p><p>--====================================================================================</p><p>--======================================================================================</p><p>--Create message type,contract,queue,services</p><p>--======================================================================================</p><p>USE InstTargetDB</p><p>GO</p><p>CREATE USER InitiatorUser WITHOUT LOGIN;</p><p><br/></p><p>CREATE CERTIFICATE InstInitiatorCertificate</p><p>&nbsp; &nbsp;AUTHORIZATION InitiatorUser</p><p>&nbsp; &nbsp;FROM FILE =&nbsp;</p><p>N&#39;\\Ms-wengao-02\cert\InstInitiatorCertificate.cer&#39;;</p><p>GO</p><p>USE InstTargetDB;</p><p>GO</p><p>ALTER ROUTE InstInitiatorRoute</p><p>WITH SERVICE_NAME = N&#39;//InstDB/2InstSample/InitiatorService&#39;,</p><p>ADDRESS = N&#39;TCP://172.22.101.96:4022&#39;;</p><p>USE msdb</p><p>GO</p><p>ALTER ROUTE InstTargetRoute</p><p>WITH SERVICE_NAME = N&#39;//TgtDB/2InstSample/TargetService&#39;,</p><p>ADDRESS =N&#39;TCP://172.22.101.214:4022&#39;;</p><p>GO</p><p>GRANT SEND ON SERVICE::[//TgtDB/2InstSample/TargetService]</p><p>TO InitiatorUser;</p><p>GO</p><p>CREATE REMOTE SERVICE BINDING InitiatorBinding</p><p>&nbsp; &nbsp; &nbsp; TO SERVICE N&#39;//InstDB/2InstSample/InitiatorService&#39;</p><p>&nbsp; &nbsp; &nbsp; WITH USER = InitiatorUser;</p><p>GO</p><p>--===============================================================================</p><p>--Step 5</p><p>--===============================================================================</p><p>USE InstTargetDB</p><p>GO</p><p>SELECT * FROM dbo.InstTargetQueue</p><p>GO</p><p>DECLARE @RecvReqDlgHandle UNIQUEIDENTIFIER;</p><p>DECLARE @RecvReqMsg NVARCHAR(100);</p><p>DECLARE @RecvReqMsgName sysname;</p><p><br/></p><p>BEGIN TRANSACTION;</p><p><br/></p><p>WAITFOR</p><p>( RECEIVE TOP(1)</p><p>&nbsp; &nbsp; @RecvReqDlgHandle = conversation_handle,</p><p>&nbsp; &nbsp; @RecvReqMsg = message_body,</p><p>&nbsp; &nbsp; @RecvReqMsgName = message_type_name</p><p>&nbsp; FROM InstTargetQueue</p><p>), TIMEOUT 1000;</p><p><br/></p><p>SELECT @RecvReqMsg AS ReceivedRequestMsg;</p><p><br/></p><p>IF @RecvReqMsgName = N&#39;//BothDB/2InstSample/RequestMessage&#39;</p><p>BEGIN</p><p>&nbsp; &nbsp; &nbsp;DECLARE @ReplyMsg NVARCHAR(100);</p><p>&nbsp; &nbsp; &nbsp;SELECT @ReplyMsg =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;&lt;ReplyMsg&gt;Message for Initiator service.&lt;/ReplyMsg&gt;&#39;;</p><p><br/></p><p>&nbsp; &nbsp; &nbsp;SEND ON CONVERSATION @RecvReqDlgHandle</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MESSAGE TYPE [//BothDB/2InstSample/ReplyMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (@ReplyMsg);</p><p><br/></p><p>&nbsp; &nbsp; &nbsp;END CONVERSATION @RecvReqDlgHandle;</p><p>END</p><p><br/></p><p>SELECT @ReplyMsg AS SentReplyMsg;</p><p><br/></p><p>SELECT @ReplyMsg;</p><p><br/></p><p>COMMIT TRANSACTION;</p><p>GO</p><p><br/></p>