<p></p><p style="white-space: normal;">--============================================================</p><p style="white-space: normal;">--查看镜像的日志传送</p><p style="white-space: normal;">sp_dbmmonitorresults database_name</p><p style="white-space: normal;">&nbsp; &nbsp;, rows_to_return</p><p style="white-space: normal;">&nbsp; &nbsp; , update_status</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">database_name</p><p style="white-space: normal;">指定返回其镜像状态的数据库。</p><p style="white-space: normal;">rows_to_return</p><p style="white-space: normal;">指定返回的行数：</p><p style="white-space: normal;">= 最后一行</p><p style="white-space: normal;">= 最后两小时的行</p><p style="white-space: normal;">= 最后四小时的行</p><p style="white-space: normal;">= 最后八小时的行</p><p style="white-space: normal;">= 最后一天的行</p><p style="white-space: normal;">= 最后两天的行</p><p style="white-space: normal;">= 最后 100 行</p><p style="white-space: normal;">= 最后 500 行</p><p style="white-space: normal;">= 最后 1,000 行</p><p style="white-space: normal;">= 最后 1,000,000 行</p><p style="white-space: normal;">update_status</p><p style="white-space: normal;">指定返回结果之前，过程：</p><p style="white-space: normal;">= 不更新数据库的状态。仅使用最后两行计算结果，其保留时间取决于何时刷新状态表。</p><p style="white-space: normal;">= 通过在计算结果之前调用 sp_dbmmonitorupdate</p><p style="white-space: normal;">来更新数据库的状态。但是，如果在前 15 秒内已更新状态表，或用户不是 sysadmin 固定服务器角色的成员，则 sp_dbmmonitorresults</p><p style="white-space: normal;">将运行，而不更新状态。</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">--============================================================</p><p style="white-space: normal;">--创建数据库镜像监视器作业，该作业可定期更新服务器实例上每个镜像数据库的镜像状态。</p><p style="white-space: normal;">sp_dbmmonitoraddmonitoring [ update_period ]</p><p style="white-space: normal;">update_period：指定更新间隔（分钟）。此值可以是介于 1 到 120 分钟之间的值。默认值为 1 分钟。</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">--============================================================</p><p style="white-space: normal;">--自定义查询</p><p style="white-space: normal;">--sp_dbmmonitoraddmonitoring 数据来源于dbm_monitor_data</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">WITH tmp AS( SELECT ROW_NUMBER()OVER(</p><p style="white-space: normal;">PARTITION BY dm.database_id</p><p style="white-space: normal;">ORDER BY dm.[local_time] DESC) AS RID,</p><p style="white-space: normal;">&nbsp;*</p><p style="white-space: normal;">FROM msdb.dbo.dbm_monitor_data dm)</p><p style="white-space: normal;">SELECT * FROM tmp WHERE RID=1</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">&nbsp;</p><p style="white-space: normal;">--------------------------------------------------------------------------------</p><p style="white-space: normal;">--补充资料</p><p style="white-space: normal;">--============================================</p><p style="white-space: normal;">--MSDN: http://technet.microsoft.com/zh-cn/library/ms173768.aspx</p><p style="white-space: normal;">--sp_dbmmonitorupdate 会插入镜像相关数据，并将超过天的历史数据删除。</p>