<p></p><p>-- =============================================</p><p>-- Author: &nbsp; &nbsp;SQL SERVER DMVS IN ACTION</p><p>-- Create date: 2013-04-04</p><p>-- Description: &nbsp; &nbsp;查找有以下问题的查询</p><p>-- 1. 缺失索引</p><p>-- 2. 列隐式转换</p><p>-- 3. 表扫描</p><p>-- 4. 缺失统计</p><p>-- =============================================</p><p>CREATE PROCEDURE &nbsp;[dbo].[usp_GetTop20MostFrequentlyExecutedAndTroubledQueries]</p><p>AS</p><p>BEGIN</p><p><br/></p><p>SET NOCOUNT ON;</p><p><br/></p><p>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED</p><p>SELECT TOP 100&nbsp;</p><p>qs.execution_count AS ExecutionCount</p><p>,CAST((qs.total_worker_time)/ 1000.0 AS DECIMAL(28,2)) AS TotalMilliSecondsForCPUTime</p><p>,CAST((qs.total_worker_time)/ 1000.0 / qs.execution_count AS DECIMAL(28, 2)) AS AvgMilliSecondsForCPUTime</p><p>,CAST((qs.total_elapsed_time- qs.total_worker_time) / 1000.0 AS DECIMAL(28,2)) AS BlockedTotalMilliSeconds</p><p>,CAST((qs.total_elapsed_time &nbsp;- qs.total_worker_time) / 1000.0 / qs.execution_count AS DECIMAL(28, 2)) AS AverageBlockingMilliSeconds</p><p>,(qs.total_logical_reads + qs.total_logical_writes) AS TotalIO</p><p>,(qs.total_logical_reads+ qs.total_logical_writes) / qs.execution_count AS AvgIO</p><p>,qs.total_physical_reads</p><p>,qs.total_logical_reads</p><p>,qs.total_logical_reads/execution_count AS avg_logical_reads</p><p>,qs.total_logical_writes</p><p>,qs.total_logical_writes/execution_count AS avg_logical_writes</p><p>,qs.last_execution_time</p><p>,SUBSTRING (qt.text,(qs.statement_start_offset/2) + 1, &nbsp; &nbsp;</p><p>((CASE WHEN qs.statement_end_offset = -1</p><p>&nbsp; &nbsp; THEN LEN(CONVERT(NVARCHAR(MAX), qt.text)) * 2</p><p>&nbsp; &nbsp; ELSE qs.statement_end_offset</p><p>&nbsp; &nbsp; END - qs.statement_start_offset)/2) + 1) AS IndividualQuery</p><p>, qt.text AS ParentQuery</p><p>, DB_NAME(qt.dbid) AS DatabaseName</p><p>, qp.query_plan</p><p>FROM sys.dm_exec_query_stats qs</p><p>CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) as qt</p><p>CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp</p><p>WHERE QS.execution_count&gt;10</p><p>AND (qs.total_logical_reads+ qs.total_logical_writes) / qs.execution_count&gt;100</p><p>AND(</p><p>CAST(qp.query_plan AS NVARCHAR(MAX)) LIKE &#39;%&lt;ColumnsWithNoStatistics&gt;%&#39; &nbsp;</p><p>OR CAST(qp.query_plan AS NVARCHAR(MAX)) LIKE &#39;%&lt;MissingIndexes&gt;%&#39;&nbsp;</p><p>OR CAST(qp.query_plan AS NVARCHAR(MAX)) LIKE &#39;%CONVERT_IMPLICIT%&#39;&nbsp;</p><p>OR CAST(qp.query_plan AS NVARCHAR(MAX)) LIKE &#39;%&lt;TableScan%&#39;</p><p>) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p><p>ORDER BY QS.execution_count DESC</p><p><br/></p><p>END</p>