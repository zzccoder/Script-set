<p></p><p style=";font-family:Calibri;font-size:10.5pt">--============================导用户===============================</p><p style=";font-family:Calibri;font-size:10.5pt">---This script will
output all user defined users, roles, along with the corresponding
sp_addrolemember statement</p><p style=";font-family:Calibri;font-size:10.5pt">IF EXISTS (
SELECT&nbsp; *</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp; sys.database_principals u</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LEFT JOIN
sys.server_principals l ON u.sid = l.sid</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHERE&nbsp;&nbsp; u.type = &#39;s&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND l.sid IS NULL</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND LEN(u.sid) &lt;= 16</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND u.sid &lt;&gt; 0x0 )</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; BEGIN</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRINT &#39;There are more than one orphan
users in this database, please fix them &#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRINT &#39;sp_change_users_login
@Action=&#39;&#39;Report&#39;&#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; END</p><p style=";;font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT
&#39;------------------------------------------DDL FOR create
user----------------------------------------------------&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;begin tran&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; begin try&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">--S = SQL 用户</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">--U = Windows 用户</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">--G = Windows 组</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">--A = 应用程序角色 !!!!!!
none</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">--R = 数据库角色</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">--C = 映射到证书的用户</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">--K = 映射到非对称密钥的用户</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">DECLARE
@sp_create_user_sqlStatement NVARCHAR(4000)</p><p style=";font-family:Calibri;font-size:10.5pt">DECLARE proc_cur
CURSOR</p><p style=";font-family:Calibri;font-size:10.5pt">FOR</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; SELECT&nbsp;
CASE u.type</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN &#39;s&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN&nbsp; --sql login</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CASE ISNULL(l.sid, 0) --</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 0</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN CASE WHEN LEN(u.sid)
&gt; 16</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN &#39;create
user [&#39; + u.name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + &#39;]
without login WITH DEFAULT_SCHEMA = &#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +
u.default_schema_name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSE &#39;create user [&#39; +
u.name + &#39;] for login [&#39; + l.name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + &#39;] WITH
DEFAULT_SCHEMA = &#39; + u.default_schema_name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN &#39;u&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN &#39;create user [&#39; + u.name +
&#39;] WITH DEFAULT_SCHEMA = &#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + u.default_schema_name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN &#39;g&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN &#39;create user [&#39; + u.name +
&#39;] WITH DEFAULT_SCHEMA = &#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + u.default_schema_name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN &#39;C&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN &#39;create user [&#39; + u.name +
&#39;] for certificate [&#39; + c.name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + &#39;]&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN &#39;K&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; THEN &#39;create user [&#39; + u.name +
&#39;] for asymmetric key [&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + a.name + &#39;]&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp;
sys.database_principals u</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LEFT JOIN sys.server_principals l
ON u.sid = l.sid</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LEFT JOIN sys.certificates c ON
u.sid = c.sid</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LEFT JOIN sys.asymmetric_keys a ON
u.sid = a.sid</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; WHERE&nbsp;&nbsp;
u.type &lt;&gt; &#39;r&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND u.principal_id &gt;
4--eliminate user dbo,guest,INFORMATION_SCHEMA,sys</p><p style=";font-family:Calibri;font-size:10.5pt">ORDER BY&nbsp;&nbsp;&nbsp; u.name</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">OPEN proc_cur;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">FETCH NEXT FROM
proc_cur&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">INTO
@sp_create_user_sqlStatement</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">WHILE @@FETCH_STATUS
= 0</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; BEGIN&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRINT &#39;&nbsp;&nbsp;&nbsp; &#39; + @sp_create_user_sqlStatement&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FETCH NEXT FROM proc_cur INTO
@sp_create_user_sqlStatement</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; END;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">CLOSE proc_cur;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">DEALLOCATE
proc_cur;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT CHAR(10) +
CHAR(10)</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT
&#39;----------------------------------------DDL FOR creating customized
role----------------------------------------------------&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">DECLARE
@sp_create_role_sqlStatement NVARCHAR(4000)</p><p style=";font-family:Calibri;font-size:10.5pt">DECLARE proc_cur
CURSOR</p><p style=";font-family:Calibri;font-size:10.5pt">FOR</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; SELECT&nbsp;
&#39;create role [&#39; + r.name + &#39;]&nbsp;
AUTHORIZATION&nbsp; [&#39; + u.name + &#39;]&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp;
sys.database_principals R</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INNER JOIN sys.database_principals
u ON r.owning_principal_id = u.principal_id</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; WHERE&nbsp;&nbsp;
r.type = &#39;r&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND r.IS_FIXED_ROLE = 0</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND u.type &lt;&gt; &#39;r&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND r.principal_id &gt; 0</p><p style=";font-family:Calibri;font-size:10.5pt">--eliminate role
&#39;public&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">OPEN proc_cur;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">FETCH NEXT FROM
proc_cur&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">INTO
@sp_create_role_sqlStatement</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">WHILE @@FETCH_STATUS
= 0</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; BEGIN&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRINT &#39;&nbsp;&nbsp;&nbsp; &#39; + @sp_create_role_sqlStatement&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FETCH NEXT FROM proc_cur INTO
@sp_create_role_sqlStatement</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; END;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">CLOSE proc_cur;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">DEALLOCATE
proc_cur;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT
&#39;----------------------------------------DDL FOR
sp_addrolemember----------------------------------------------------&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">DECLARE
@sp_addrolemember_sqlStatement NVARCHAR(MAX)</p><p style=";font-family:Calibri;font-size:10.5pt">DECLARE proc_cur
CURSOR</p><p style=";font-family:Calibri;font-size:10.5pt">FOR</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; SELECT&nbsp;
&#39;exec sp_addrolemember &#39;&#39;&#39; + g.name + &#39;&#39;&#39;,&#39;&#39;&#39; + u.name + &#39;&#39;&#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp;
sys.database_principals u ,</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.database_principals g ,</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.database_role_members m</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; WHERE&nbsp;&nbsp;
g.principal_id = m.role_principal_id</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND u.principal_id =
m.member_principal_id</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AND u.name &lt;&gt; &#39;dbo&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">OPEN proc_cur;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">FETCH NEXT FROM
proc_cur&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">INTO
@sp_addrolemember_sqlStatement</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">WHILE @@FETCH_STATUS
= 0</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; BEGIN&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRINT &#39;&nbsp;&nbsp;&nbsp; &#39; + @sp_addrolemember_sqlStatement&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FETCH NEXT FROM proc_cur INTO
@sp_addrolemember_sqlStatement</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;&nbsp;&nbsp; END;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">CLOSE proc_cur;&nbsp;&nbsp;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">DEALLOCATE
proc_cur;&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";;font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp;&nbsp;&nbsp; goto successed&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; end try&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; begin catch&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp;&nbsp;&nbsp; print ERROR_MESSAGE()&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp;&nbsp;&nbsp; goto failed&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; end catch&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;successed:&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; commit&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; print &#39;&#39;successed&#39;&#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; return&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;failed:&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; rollback&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; print &#39;&#39;failed&#39;&#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">PRINT &#39;&nbsp; print &#39;&#39;rollback&#39;&#39;&#39;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p><p style=";font-family:Calibri;font-size:10.5pt">&nbsp;</p>