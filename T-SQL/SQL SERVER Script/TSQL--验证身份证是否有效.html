<p></p><p>/****** Object: &nbsp;UserDefinedFunction [dbo].[udf_IsvalidIDCard] &nbsp; &nbsp;Script Date: 02/27/2014 16:03:20 ******/</p><p>SET ANSI_NULLS ON</p><p>GO</p><p><br/></p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p><br/></p><p>CREATE FUNCTION [dbo].[udf_IsvalidIDCard]</p><p>(</p><p>@IDCardNo VARCHAR(50)=&#39;&#39;</p><p>)</p><p>RETURNS BIT</p><p>AS</p><p>/*******************************************************************</p><p>函数名称：udf_IsvalidIDCard()</p><p>参数:@IDCardNo string 身份证号码</p><p>返回值： &nbsp;bit 是否有效</p><p>功能描述：判断身份证号码是否合法</p><p><br/></p><p>备注：目前中国的身份证号码有18位和15位.</p><p>1，18位身份证号码的组成:6位地区编码＋8位出生年月日＋3位编号（奇男偶女）＋1位校验码</p><p>2，15位身份证号码的组成:6位地区编码＋6位出生年月日＋3位编号（奇男偶女）</p><p>*******************************************************************/</p><p>BEGIN</p><p><br/></p><p>DECLARE @Length INT,&nbsp;</p><p>@Loop INT,&nbsp;</p><p>@Sum INT</p><p>DECLARE @SingleChar CHAR</p><p><br/></p><p>SET @Sum = 0</p><p>IF @IDCardNo IS NULL OR @IDCardNo = NULL OR LTRIM(RTRIM(@IDCardNo)) = &#39;&#39;</p><p>BEGIN</p><p>RETURN 0</p><p>END</p><p><br/></p><p>SET @Length = LEN(@IDCardNo)</p><p>--判断位数</p><p>IF @Length &lt; &gt; 18 AND @Length &lt; &gt; 15</p><p>BEGIN</p><p>RETURN 0 &nbsp; &nbsp;</p><p>END</p><p>IF @Length = 18</p><p>BEGIN</p><p>IF ISNUMERIC(LEFT(@IDCardNo, 17)) = 0</p><p>BEGIN &nbsp; &nbsp;</p><p>RETURN 0</p><p>END</p><p>IF ISDATE(SUBSTRING(@IDCardNo, 7, 4) + &#39;-&#39; + SUBSTRING(@IDCardNo, 11, 2) + &#39;-&#39; + SUBSTRING(@IDCardNo, 13, 2)) = 0&nbsp;</p><p>BEGIN</p><p>RETURN 0</p><p>END</p><p>SET @Loop = 17</p><p>WHILE (@Loop &nbsp;&gt;= 1)</p><p>BEGIN</p><p>SET @Sum = @Sum + CONVERT(INT,SUBSTRING(@IDCardNo, @Loop, 1)) * (POWER(2,(18 - @Loop)) % 11)</p><p>SET @Loop = @Loop - 1</p><p>END</p><p>SET @Loop = @Sum % 11</p><p>IF @Loop = 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp;BEGIN</p><p>SET @SingleChar = &#39;1&#39;</p><p>END</p><p>&nbsp; &nbsp; &nbsp; ELSE IF @Loop = 1</p><p>BEGIN</p><p>SET @SingleChar = &#39;0&#39;</p><p>END</p><p>&nbsp; &nbsp; &nbsp; ELSE IF @Loop = 2</p><p>BEGIN</p><p>SET @SingleChar = &#39;X&#39;</p><p>END</p><p>&nbsp; &nbsp; &nbsp; ELSE</p><p>BEGIN</p><p>SET @SingleChar = CONVERT(VARCHAR(2),(12 - @Loop))</p><p>END</p><p>IF LOWER(RIGHT(@IDCardNo, 1)) &lt; &gt; LOWER(@SingleChar)</p><p>BEGIN</p><p>RETURN 0</p><p>END</p><p>END</p><p>ELSE IF @Length = 15</p><p>BEGIN</p><p>IF ISNUMERIC(@IDCardNo) = 0</p><p>BEGIN</p><p>RETURN 0</p><p>END &nbsp; &nbsp;</p><p>IF ISDATE(&#39;19&#39; + SUBSTRING(@IDCardNo, 7, 2) + &#39;-&#39; + SUBSTRING(@IDCardNo, 9, 2) + &#39;-&#39; + SUBSTRING(@IDCardNo, 11, 2)) = 0&nbsp;</p><p>BEGIN</p><p>RETURN 0</p><p>END</p><p>END</p><p><br/></p><p>RETURN 1</p><p><br/></p><p>END</p><p>GO</p>