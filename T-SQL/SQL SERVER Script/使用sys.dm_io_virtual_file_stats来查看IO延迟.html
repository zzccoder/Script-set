<p>/*============================================================================</p><p>&nbsp; File: &nbsp; &nbsp; VirtualFileStats.sql</p><p><br/></p><p>&nbsp; Summary: &nbsp;sys.dm_io_virtual_file_stats</p><p><br/></p><p>&nbsp; Date: &nbsp; &nbsp; March 2011</p><p><br/></p><p>------------------------------------------------------------------------------</p><p>&nbsp; Written by Paul S. Randal, SQLskills.com</p><p><br/></p><p>&nbsp; (c) 2011, SQLskills.com. All rights reserved.</p><p><br/></p><p>&nbsp; For more scripts and sample code, check out&nbsp;</p><p>&nbsp; &nbsp; http://www.SQLskills.com</p><p><br/></p><p>&nbsp; You may alter this code for your own *non-commercial* purposes. You may</p><p>&nbsp; republish altered code as long as you include this copyright and give due</p><p>&nbsp; credit, but you must obtain prior permission before blogging this code.</p><p>&nbsp;&nbsp;</p><p>&nbsp; THIS CODE AND INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT WARRANTY OF&nbsp;</p><p>&nbsp; ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED&nbsp;</p><p>&nbsp; TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A</p><p>&nbsp; PARTICULAR PURPOSE.</p><p>============================================================================*/</p><p><br/></p><p>-- Use this script, based on code from Jimmy May</p><p>-- This is what I use on client systems</p><p>SELECT&nbsp;</p><p>&nbsp; &nbsp; --virtual file latency</p><p>&nbsp; &nbsp; ReadLatency =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN num_of_reads = 0</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN 0 ELSE (io_stall_read_ms / num_of_reads) END,</p><p>&nbsp; &nbsp; WriteLatency =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN num_of_writes = 0&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN 0 ELSE (io_stall_write_ms / num_of_writes) END,</p><p>&nbsp; &nbsp; Latency =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN (num_of_reads = 0 AND num_of_writes = 0)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN 0 ELSE (io_stall / (num_of_reads + num_of_writes)) END,</p><p>&nbsp; --avg bytes per IOP</p><p>&nbsp; &nbsp; AvgBPerRead =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN num_of_reads = 0&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN 0 ELSE (num_of_bytes_read / num_of_reads) END,</p><p>&nbsp; &nbsp; AvgBPerWrite =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN io_stall_write_ms = 0&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN 0 ELSE (num_of_bytes_written / num_of_writes) END,</p><p>&nbsp; &nbsp; AvgBPerTransfer =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN (num_of_reads = 0 AND num_of_writes = 0)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN 0 ELSE</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((num_of_bytes_read + num_of_bytes_written) /&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (num_of_reads + num_of_writes)) END,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>&nbsp; &nbsp; LEFT (mf.physical_name, 2) AS Drive,</p><p>&nbsp; &nbsp; DB_NAME (vfs.database_id) AS DB,</p><p>&nbsp; &nbsp; vfs.*,</p><p>&nbsp; &nbsp; mf.physical_name</p><p>FROM sys.dm_io_virtual_file_stats (NULL,NULL) AS vfs</p><p>JOIN sys.master_files AS mf</p><p>&nbsp; &nbsp; ON vfs.database_id = mf.database_id</p><p>&nbsp; &nbsp; AND vfs.file_id = mf.file_id</p><p>--WHERE vfs.file_id = 2 -- log files</p><p>-- ORDER BY Latency DESC</p><p>-- ORDER BY ReadLatency DESC</p><p>ORDER BY WriteLatency DESC</p><p><br/></p>