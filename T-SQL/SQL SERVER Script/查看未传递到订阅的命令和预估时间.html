<p></p><p>--查看为传递到订阅的命令和预估时间</p><p>--在分发服务器执行&nbsp;</p><p>IF(OBJECT_ID(&#39;tempdb..#tmpSubscribers&#39;) IS NOT NULL)</p><p>BEGIN</p><p>DROP TABLE #tmpSubscribers</p><p>END</p><p>GO</p><p>--IF(OBJECT_ID(&#39;tempdb..#tmpPendingResult&#39;) IS NOT NULL)</p><p>--BEGIN</p><p>--DROP TABLE #tmpPendingResult</p><p>--END</p><p><br/></p><p>--GO</p><p>--IF(OBJECT_ID(&#39;tempdb..#tmpSinglePendingResult&#39;) IS NOT NULL)</p><p>--BEGIN</p><p>--DROP TABLE #tmpSinglePendingResult</p><p>--END</p><p>GO</p><p>USE distribution&nbsp;</p><p>GO</p><p>SELECT &nbsp;</p><p>a.publisher</p><p>,a.publisher_db</p><p>,a.publication</p><p>,c.name as subscriber</p><p>,b.subscriber_db as subscriber_db</p><p>,CAST(b.subscription_type AS VARCHAR) as subscription_type</p><p>,&#39;EXEC distribution.sys.sp_replmonitorsubscriptionpendingcmds @publisher = N&#39;&#39;&#39;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + a.publisher + &#39;&#39;&#39;, @publisher_db = N&#39;&#39;&#39; + a.publisher_db</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + &#39;&#39;&#39;, @publication = N&#39;&#39;&#39; + a.publication + &#39;&#39;&#39;, @subscriber = N&#39;&#39;&#39;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + c.name + &#39;&#39;&#39;, @subscriber_db = N&#39;&#39;&#39; + b.subscriber_db</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + &#39;&#39;&#39;, @subscription_type =&#39; + CAST(b.subscription_type AS VARCHAR) AS ScriptTxt</p><p>INTO #tmpSubscribers</p><p>FROM &nbsp; &nbsp;dbo.MSreplication_monitordata a ( NOLOCK )</p><p>&nbsp; &nbsp; &nbsp; &nbsp; JOIN ( SELECT &nbsp; publication_id ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subscriber_id ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subscriber_db ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subscription_type</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM &nbsp; &nbsp; MSsubscriptions (NOLOCK)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GROUP BY publication_id ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subscriber_id ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subscriber_db ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subscription_type</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) b ON a.publication_id = b.publication_id</p><p>&nbsp; &nbsp; &nbsp; &nbsp; JOIN sys.servers c ( NOLOCK ) ON b.subscriber_id = c.server_id</p><p>WHERE &nbsp; a.agent_type = 1</p><p>--====================================================</p><p>--CREATE TABLE #tmpPendingResult</p><p>--(</p><p>--publisher NVARCHAR(200)</p><p>--,publisher_db NVARCHAR(200)</p><p>--,publication NVARCHAR(200)</p><p>--,subscriber NVARCHAR(200)</p><p>--,subscriber_db NVARCHAR(200)</p><p>--,subscription_type NVARCHAR(200)</p><p>--,pendingcmdcount BIGINT</p><p>--,estimatedprocesstime BIGINT</p><p>--)</p><p><br/></p><p>--CREATE TABLE #tmpSinglePendingResult</p><p>--(</p><p>--pendingcmdcount BIGINT</p><p>--,estimatedprocesstime BIGINT</p><p>--)</p><p><br/></p><p>--==================================================</p><p>--使用游标遍历</p><p>DECLARE @publisher NVARCHAR(200);;</p><p>DECLARE @publisher_db NVARCHAR(200);</p><p>DECLARE @publication NVARCHAR(200);</p><p><br/></p><p>DECLARE @subscriber NVARCHAR(200);;</p><p>DECLARE @subscriber_db NVARCHAR(200);</p><p>DECLARE @subscription_type NVARCHAR(200);</p><p>DECLARE @ScriptTxt NVARCHAR(MAX);</p><p><br/></p><p>DECLARE MyCursor CURSOR FOR</p><p>SELECT publisher</p><p>,publisher_db&nbsp;</p><p>,publication</p><p>,subscriber</p><p>,subscriber_db</p><p>,subscription_type</p><p>,ScriptTxt</p><p>FROM #tmpSubscribers;</p><p><br/></p><p><br/></p><p>OPEN MyCursor</p><p><br/></p><p>FETCH NEXT FROM MyCursor&nbsp;</p><p>INTO @publisher</p><p>,@publisher_db&nbsp;</p><p>,@publication</p><p>,@subscriber</p><p>,@subscriber_db</p><p>,@subscription_type</p><p>,@ScriptTxt;</p><p><br/></p><p><br/></p><p><br/></p><p>WHILE @@FETCH_STATUS = 0</p><p>BEGIN</p><p>SELECT&nbsp;</p><p>@publisher AS publisher</p><p>,@publisher_db AS publisher_db</p><p>,@publication AS publication</p><p>,@subscriber AS subscriber</p><p>,@subscriber_db AS subscriber_db</p><p>,@subscription_type AS subscription_type</p><p>,@ScriptTxt;</p><p><br/></p><p>EXEC(@ScriptTxt)</p><p><br/></p><p><br/></p><p>FETCH NEXT FROM MyCursor&nbsp;</p><p>INTO @publisher</p><p>,@publisher_db&nbsp;</p><p>,@publication</p><p>,@subscriber</p><p>,@subscriber_db</p><p>,@subscription_type</p><p>,@ScriptTxt;</p><p><br/></p><p>END</p><p><br/></p><p>CLOSE MyCursor</p><p>DEALLOCATE MyCursor</p><p><br/></p><p><br/></p>