<p>--==================================================</p><p>--查看正在执行的SQL</p><p>SELECT &nbsp;s.[session_id] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[start_time] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; DATEDIFF(MILLISECOND, r.start_time, GETDATE()) AS elapsed_MS ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[status] AS RequestStatus ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; DB_NAME(r.database_id) AS DatabaseName ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[wait_type] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[wait_resource] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[wait_time] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[reads] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[writes] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; r.[logical_reads] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; s.[status] AS SessionStatus ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; s.[host_name] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; s.[original_login_name] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; s.[nt_user_name] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; s.[program_name] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; s.[client_interface_name] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; c.[client_net_address] ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; SUBSTRING(qt.text, r.statement_start_offset / 2,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ( CASE WHEN r.statement_end_offset = -1</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;THEN LEN(CONVERT(NVARCHAR(MAX), qt.text)) * 2</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE r.statement_end_offset</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END - r.statement_start_offset ) / 2) AS ExecutingSQL ,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; qp.query_plan</p><p>FROM &nbsp; &nbsp;sys.dm_exec_requests r</p><p>&nbsp; &nbsp; &nbsp; &nbsp; INNER JOIN sys.dm_exec_sessions s ON r.session_id = s.session_id</p><p>&nbsp; &nbsp; &nbsp; &nbsp; LEFT JOIN sys.dm_exec_connections c ON c.session_id = s.session_id</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) AS qt</p><p>&nbsp; &nbsp; &nbsp; &nbsp; CROSS APPLY sys.dm_exec_query_plan(r.plan_handle) AS qp</p><p>ORDER BY elapsed_MS DESC</p><p><br/></p>