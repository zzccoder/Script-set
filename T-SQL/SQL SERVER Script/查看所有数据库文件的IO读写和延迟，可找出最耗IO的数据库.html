<p>--==========================================================</p><p>--查看所有数据库文件的IO读写和延迟，可找出最耗IO的数据库</p><p><br/></p><p>DROP TABLE #TB_Databaese</p><p>DROP TABLE #TB_IOStats</p><p>GO</p><p>CREATE TABLE #TB_Databaese</p><p>(</p><p>&nbsp; &nbsp; [DatabaseID] INT,</p><p>&nbsp; &nbsp; [FileId] INT,</p><p>&nbsp; &nbsp; [FileLogicName] NVARCHAR(200),</p><p>&nbsp; &nbsp; [FileType] NVARCHAR(20)</p><p>)</p><p><br/></p><p>EXEC SP_MSFOREACHDB N&#39;</p><p>USE [?];</p><p>INSERT INTO #TB_Databaese</p><p>(</p><p>&nbsp; &nbsp; DatabaseID,</p><p>&nbsp; &nbsp; FileId,</p><p>&nbsp; &nbsp; [FileLogicName],</p><p>&nbsp; &nbsp; FileType</p><p>)</p><p>SELECT DB_ID() AS DatabaseID,</p><p>file_id AS FileId,</p><p>name AS [FileLogicName],</p><p>type_desc AS [FileType]</p><p>FROM sys.database_files</p><p>&#39;</p><p><br/></p><p><br/></p><p>SELECT *&nbsp;</p><p>INTO #TB_IOStats</p><p>FROM sys.dm_io_virtual_file_stats(1,1) AS T2</p><p>WHERE 1&lt;&gt;1</p><p><br/></p><p><br/></p><p>DECLARE @DatabaseID INT;</p><p>DECLARE @FileId INT</p><p><br/></p><p>DECLARE MyCursor CURSOR FOR</p><p>SELECT T1.[DatabaseID],T1.FileId&nbsp;</p><p>FROM #TB_Databaese T1</p><p><br/></p><p><br/></p><p>OPEN MyCursor</p><p>FETCH NEXT FROM MyCursor&nbsp;</p><p>INTO @DatabaseID,@FileId</p><p><br/></p><p>WHILE @@FETCH_STATUS = 0</p><p>BEGIN</p><p><br/></p><p>INSERT INTO #TB_IOStats</p><p>SELECT *&nbsp;</p><p>FROM sys.dm_io_virtual_file_stats(@DatabaseID,@FileId) AS T2</p><p><br/></p><p>FETCH NEXT FROM MyCursor&nbsp;</p><p>INTO @DatabaseID,@FileId</p><p>END</p><p><br/></p><p>CLOSE MyCursor</p><p>DEALLOCATE MyCursor</p><p><br/></p><p>SELECT DB_NAME(T1.database_id) AS DatabaseName</p><p>,*&nbsp;</p><p>FROM #TB_IOStats T1</p><p>ORDER BY T1.database_id,T1.[file_id]</p><p><br/></p>