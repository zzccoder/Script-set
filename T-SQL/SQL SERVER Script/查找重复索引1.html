<p>/*============================================================================</p><p>&nbsp; File: &nbsp; &nbsp; sp_SQLskills_ExposeColsInIndexLevels_INCLUDE_UNORDERED</p><p><br/></p><p>&nbsp; Summary: &nbsp;This procedure is similar to the one that displays EXACTLY what&#39;s in</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the leaf/non-leaf levels of an index except that it orders the&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; columns in the INCLUDE list (that aren&#39;t already in the nonclustered</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index key OR the clustering key) so that we can TRULY find duplicate&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; indexes. It&#39;s annoying that you need both of these procs but alas</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; you do!</p><p><span class="Apple-tab-span" style="white-space:pre">			</span></p><p>&nbsp; Date: &nbsp; &nbsp; July 2011</p><p><br/></p><p>&nbsp; Version:<span class="Apple-tab-span" style="white-space:pre">	</span>SQL Server 2005/2008</p><p>------------------------------------------------------------------------------</p><p>&nbsp; Written by Kimberly L. Tripp, SQLskills.com</p><p><br/></p><p>&nbsp; For more scripts and sample code, check out&nbsp;</p><p>&nbsp; &nbsp; http://www.SQLskills.com</p><p><br/></p><p>&nbsp; This script is intended only as a supplement to demos and lectures</p><p>&nbsp; given by SQLskills instructors. &nbsp;</p><p>&nbsp;&nbsp;</p><p>&nbsp; THIS CODE AND INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT WARRANTY OF&nbsp;</p><p>&nbsp; ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED&nbsp;</p><p>&nbsp; TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A</p><p>&nbsp; PARTICULAR PURPOSE.</p><p>============================================================================*/</p><p><br/></p><p>USE master</p><p>go</p><p><br/></p><p>if OBJECTPROPERTY(OBJECT_ID(&#39;sp_SQLskills_ExposeColsInIndexLevels_INCLUDE_UNORDERED&#39;), &#39;IsProcedure&#39;) = 1</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>drop procedure sp_SQLskills_ExposeColsInIndexLevels_INCLUDE_UNORDERED</p><p>go</p><p><br/></p><p>create procedure sp_SQLskills_ExposeColsInIndexLevels_INCLUDE_UNORDERED&nbsp;</p><p>(</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>@object_id int,</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>@index_id int,</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>@ColsInTree nvarchar(2126) OUTPUT,</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>@ColsInLeaf nvarchar(max) OUTPUT</p><p>)</p><p>AS</p><p>BEGIN</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>declare @nonclus_uniq int</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>, @column_id int</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>, @column_name nvarchar(260)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>, @col_descending bit</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>, @colstr<span class="Apple-tab-span" style="white-space:pre">	</span>nvarchar (max);</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Get clustered index keys (id and name)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>select sic.column_id, QUOTENAME(sc.name, N&#39;]&#39;) AS column_name, is_descending_key</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>into #clus_keys&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>from sys.index_columns AS sic</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>JOIN sys.columns AS sc</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>ON sic.column_id = sc.column_id AND sc.object_id = sic.object_id</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>where sic.[object_id] = @object_id</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>and [index_id] = 1;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Get nonclustered index keys</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>select sic.column_id, sic.is_included_column, QUOTENAME(sc.name, N&#39;]&#39;) AS column_name, is_descending_key</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>into #nonclus_keys&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>from sys.index_columns AS sic</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>JOIN sys.columns AS sc</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>ON sic.column_id = sc.column_id&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>AND sc.object_id = sic.object_id</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>where sic.[object_id] = @object_id</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>and sic.[index_id] = @index_id;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Is the nonclustered unique?</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>select @nonclus_uniq = is_unique&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>from sys.indexes</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>where [object_id] = @object_id</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>and [index_id] = @index_id;</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>if (@nonclus_uniq = 0)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- Case 1: nonunique nonclustered index</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- cursor for nonclus columns not included and</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- nonclus columns included but also clus keys</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare mycursor cursor for</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select column_id, column_name, is_descending_key &nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>from #nonclus_keys</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>where is_included_column = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>open mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHILE @@FETCH_STATUS = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @colstr = ISNULL(@colstr, N&#39;&#39;) + @column_name + CASE WHEN @col_descending = 1 THEN &#39;(-)&#39; ELSE N&#39;&#39; END + N&#39;, &#39;;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>close mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- cursor over clus_keys if clustered</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare mycursor cursor for</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select column_id, column_name, is_descending_key from #clus_keys</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>where column_id not in (select column_id from #nonclus_keys</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>where is_included_column = 0)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>open mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHILE @@FETCH_STATUS = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @colstr = ISNULL(@colstr, N&#39;&#39;) + @column_name + CASE WHEN @col_descending = 1 THEN &#39;(-)&#39; ELSE N&#39;&#39; END + N&#39;, &#39;;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>close mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate mycursor;<span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @ColsInTree = substring(@colstr, 1, LEN(@colstr) -1);</p><p><span class="Apple-tab-span" style="white-space:pre">			</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- find columns not in the nc and not in cl - that are still left to be included.</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare mycursor cursor for</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select column_id, column_name, is_descending_key from #nonclus_keys</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>where column_id not in (select column_id from #clus_keys UNION select column_id from #nonclus_keys where is_included_column = 0)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>order by column_name</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>open mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHILE @@FETCH_STATUS = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @colstr = ISNULL(@colstr, N&#39;&#39;) + @column_name + CASE WHEN @col_descending = 1 THEN &#39;(-)&#39; ELSE N&#39;&#39; END + N&#39;, &#39;;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>close mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate mycursor;<span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @ColsInLeaf = substring(@colstr, 1, LEN(@colstr) -1);</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>end</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Case 2: unique nonclustered</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>else</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- cursor over nonclus_keys that are not includes</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @colstr = &#39;&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare mycursor cursor for</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select column_id, column_name, is_descending_key from #nonclus_keys</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>where is_included_column = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>open mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHILE @@FETCH_STATUS = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @colstr = ISNULL(@colstr, N&#39;&#39;) + @column_name + CASE WHEN @col_descending = 1 THEN &#39;(-)&#39; ELSE N&#39;&#39; END + N&#39;, &#39;;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>close mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @ColsInTree = substring(@colstr, 1, LEN(@colstr) -1);</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- start with the @ColsInTree and add remaining columns not present...</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare mycursor cursor for</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select column_id, column_name, is_descending_key from #nonclus_keys&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>WHERE is_included_column = 1;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>open mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHILE @@FETCH_STATUS = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @colstr = ISNULL(@colstr, N&#39;&#39;) + @column_name + CASE WHEN @col_descending = 1 THEN &#39;(-)&#39; ELSE N&#39;&#39; END + N&#39;, &#39;;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>close mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate mycursor;</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- get remaining clustered column as long as they&#39;re not already in the nonclustered</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare mycursor cursor for</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select column_id, column_name, is_descending_key from #clus_keys</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>where column_id not in (select column_id from #nonclus_keys)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>order by column_name</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>open mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHILE @@FETCH_STATUS = 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @colstr = ISNULL(@colstr, N&#39;&#39;) + @column_name + CASE WHEN @col_descending = 1 THEN &#39;(-)&#39; ELSE N&#39;&#39; END + N&#39;, &#39;;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>fetch next from mycursor into @column_id, @column_name, @col_descending;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>close mycursor;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate mycursor;<span class="Apple-tab-span" style="white-space:pre">	</span></p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @ColsInLeaf = substring(@colstr, 1, LEN(@colstr) -1);</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @colstr = &#39;&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Cleanup</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>drop table #clus_keys;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>drop table #nonclus_keys;</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p>END;</p><p>GO</p><p><br/></p><p>exec sys.sp_MS_marksystemobject &#39;sp_SQLskills_ExposeColsInIndexLevels_INCLUDE_UNORDERED&#39;</p><p>go</p><p><br/></p>