<p>USE master;</p><p>SET NOCOUNT ON;</p><p>GO</p><p>DECLARE @dbname varchar(255); --数据库名</p><p>DECLARE @snapname varchar(255);--快照名</p><p>DECLARE @snap_dir varchar(255);--保存路径</p><p>&nbsp;</p><p>SET @dbname=&#39;DB1&#39;;</p><p>SET @snapname=&#39;DB1_SNAP&#39;;</p><p>SET @snap_dir=&#39;D:\DB\&#39;</p><p>BEGIN TRY</p><p>-- 删除快照如果快照存在</p><p>IF &nbsp;EXISTS (SELECT name FROM master.sys.databases</p><p>WHERE name = @snapname)</p><p>BEGIN</p><p>&nbsp; &nbsp;EXEC (&#39;DROP DATABASE &#39;+@snapname);</p><p>END</p><p>&nbsp;</p><p>--将数据库文件放入临时表中</p><p>SELECT name AS DBFileName INTO #tempFiles</p><p>FROM master.sys.master_files</p><p>WHERE type&lt;&gt;1 AND database_id=DB_ID(@dbname);</p><p>DECLARE @tempSQL NVARCHAR(2000);</p><p>DECLARE @tempFileName NVARCHAR(200)</p><p>SET @tempSQL=&#39;CREATE &nbsp;DATABASE &#39;+@snapname+&#39; ON &#39;;</p><p>WHILE((SELECT COUNT(1) FROM #tempFiles)&gt;0)</p><p>BEGIN</p><p>&nbsp; &nbsp;SELECT TOP(1) @tempFileName=DBFileName FROM #tempFiles;</p><p>&nbsp; &nbsp;SET @tempSQL=@tempSQL+&#39;(NAME=&#39;+&#39;&#39;&#39;&#39;+@tempFileName+&#39;&#39;&#39;,FILENAME=&#39;&#39;&#39;+@snap_dir+@tempFileName+&#39;.snap&#39;&#39;)&#39;;</p><p>&nbsp; &nbsp;DELETE FROM #tempFiles WHERE DBFileName=@tempFileName;</p><p>END</p><p>DROP TABLE #tempFiles;</p><p>SET @tempSQL=@tempSQL+&#39;AS SNAPSHOT OF &#39;+@dbname+&#39;;&#39;</p><p>&nbsp;</p><p>PRINT &#39;创建脚本：&#39;</p><p>PRINT @tempSQL;</p><p>EXEC(@tempSQL)</p><p>PRINT &#39;创建成功&#39;;</p><p>&nbsp;</p><p>END TRY</p><p>BEGIN CATCH</p><p>PRINT &#39;执行出错，错误信息：&#39;</p><p>PRINT ERROR_MESSAGE()</p><p>END CATCH</p><p><br/></p>