<p>--CDC通过对事务日志的异步读取，记录DML操作的发生时间、</p><p>--类型和实际影响的数据变化，然后将这些数据记录到启用</p><p>--CDC时自动创建的表中。通过cdc相关的存储过程，可以获</p><p>--取详细的数据变化情况。由于数据变化是异步读取的，因</p><p>--此对整体性能的影响不大，远小于通过Trigger实现的数据</p><p>--变化记录。</p><p><br/></p><p>--对应未引发数据变化的更新操作，不会被记录到变更表中。</p><p><br/></p><p>--CDC和复制代理使用同样的日志读取器，在捕获数据变更时有一定延迟，即使在简单回复模式下，未被读取的日志仍无法截断</p><p></p><p><br/></p><p>--CDC捕获所得数据默认保存三天，以避免频繁变更操作导致捕获表变得臃肿，CDC使用JOB来清理过期数据。</p><p>--===================================================</p><p>--创建测试数据库</p><p>CREATE DATABASE DemoDB&nbsp;</p><p>--===================================================</p><p>--检查当前数据库是否启用CDC</p><p>--is_cdc_enabled=1：未启用，is_cdc_enabled=1：已启用</p><p>USE DemoDB</p><p>GO</p><p>SELECT D.is_cdc_enabled FROM sys.databases D</p><p>WHERE D.database_id=DB_ID()</p><p>---===================================================</p><p>--启用当前数据库CDC功能</p><p>EXEC sp_cdc_enable_db</p><p><br/></p><p>--====================================================</p><p>--创建测试表TB1</p><p><br/></p><p>CREATE TABLE TB1</p><p>(</p><p>ID INT IDENTITY(1,1) PRIMARY KEY,</p><p>C1 NVARCHAR(200)</p><p>)</p><p>--====================================================</p><p>--检查测试表是否启用CDC</p><p>--is_tracked_by_cdc=1：未启用，is_tracked_by_cdc=1：已启用</p><p>SELECT T.is_tracked_by_cdc FROM sys.tables T</p><p>WHERE T.name=N&#39;TB1&#39;</p><p><br/></p><p><br/></p><p>--=====================================================</p><p>--启用CDC，要求表有主键或指定唯一索引</p><p>--在第一次启动表后会创建两个作业</p><p>--作业 &#39;cdc.DemoDB_capture&#39; 已成功启动。</p><p>--作业 &#39;cdc.DemoDB_cleanup&#39; 已成功启动。</p><p>EXEC sys.sp_cdc_enable_table</p><p>@source_schema = &#39;dbo&#39;,</p><p>@source_name = &#39;TB1&#39;,</p><p>@role_name = NULL,</p><p>@capture_instance = NULL,</p><p>@supports_net_changes = 1,</p><p>@index_name = NULL,</p><p>@captured_column_list = NULL,</p><p>@filegroup_name = default&nbsp;</p><p><br/></p><p>--=====================================================</p><p>--修改表中数据测试</p><p>INSERT INTO TB1(C1)VALUES(N&#39;123&#39;)</p><p>UPDATE TB1 SET C1=N&#39;456&#39; WHERE C1=N&#39;123&#39;</p><p>DELETE FROM TB1 WHERE C1=N&#39;456&#39;</p><p><br/></p><p>-------------------------------------------------------</p><p>--查看捕获的记录，变更记录表名：cdc.[TableName]_CT</p><p>--__$operation列对应操作类型:&nbsp;</p><p>--1=delete，&nbsp;</p><p>--2=insert，&nbsp;</p><p>--3=update(旧值)， &nbsp; &nbsp;&nbsp;</p><p>--4=update(新值)。</p><p><br/></p><p>SELECT * FROM cdc.dbo_TB1_CT</p><p><br/></p><p>&nbsp;</p><p><br/></p><p>--========================================================</p><p>--禁用数据捕获</p><p>EXEC sys.sp_cdc_disable_table</p><p>@source_schema = N&#39;dbo&#39;,</p><p>@source_name &nbsp; = N&#39;TB1&#39;</p><p>@capture_instance=&#39;ALL&#39;</p><p><br/></p><p><br/></p><p>--========================================================</p><p>--禁用数据捕获</p><p>EXEC sys.sp_cdc_disable_db</p><p><br/></p><p>&nbsp;</p><p><br/></p><p>--=========================================================</p><p><br/></p><p>1.当开启CDC的表中某列被删除后，该列仍会在对应的CDC表中保存，后续插入的行中此列值为NULL</p><p><br/></p><p>2.当开启CDC的表中增加新列时，该新列不会被CDC跟踪捕获</p><p><br/></p><p>3.开启CDC后，在BULK_LOGGED恢复模式下，除索引重整和索引重建外，其他所有操作都全日志记录(与完整恢复模式下一样)</p><p><br/></p><p>4.开启CDC后，应尽量避免对CDC的表做大批量数据操作</p><p><br/></p><p>5.应考虑将CDC 清理作业设置在业务低峰期运行</p><p><br/></p><p>6.应考虑将CDC 的系统表与数据表分开存放到不同文件组</p><p><br/></p><p>7.慎用&#39;alloc net change&#39;</p><p><br/></p><p>8.可以使用EXEC sys.sp_cdc_get_ddl_history &#39;TABLE NAME&#39;来查看CDC跟踪捕获的表的DDL操作历史记录</p><p><br/></p><p>9.可以使用对应的函数cdc.fn_cdc_get_all_changes_schema_tablename(minlsn,maxlsn,&#39;type&#39;)来查看所有数据变更，而使用cdc.fn_cdc_get_net_changes_tablename来查看净更改行(如果改行被更新多次，只返回最终内容的一行；如果一条数据被新增后又被删除，不会显示该行)。</p><p><br/></p><p>10.可以使用cdc.lsn_time_mapping来查看时间和lsn的对应关系</p><p><br/></p><p>11.可以使用sys.dm_cdc_errors来查看为变更数据捕获日志扫描会话中遇到的每个错误返回一行</p><p><br/></p><p>12.可以使用sys.dm_cdc_log_scan_sessions 来查看当前数据库中每个日志扫描回话的信息</p><p><br/></p><p>&nbsp;</p><p><br/></p><p><br/></p><p>--================================================</p><p><br/></p>