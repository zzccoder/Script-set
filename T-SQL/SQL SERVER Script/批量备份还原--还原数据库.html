<p></p><p style="white-space: normal;">Use master</p><p style="white-space: normal;">GO</p><p style="white-space: normal;">/*=================Usp_RestoreDataBaseFormPath=======================================</p><p style="white-space: normal;">&nbsp; =====Restore Single DataBase From a Back File &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;======</p><p style="white-space: normal;">&nbsp; =====Ken.Guo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ======</p><p style="white-space: normal;">&nbsp; =====2010.9.10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;======</p><p style="white-space: normal;">&nbsp; =====Version: 2005 &amp; 2008 SQL Server &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ======</p><p style="white-space: normal;">&nbsp; =====Usp_RestoreDataBaseFormPath &#39;D:\databack\dbcenter.bak&#39;,&#39;D:\Data&#39;,0 &nbsp; &nbsp; &nbsp;======</p><p style="white-space: normal;">&nbsp; =====Key Point Info: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ======</p><p style="white-space: normal;">&nbsp; --Restore HeaderOnly &nbsp;from disk=&#39;D:\data\xx.bak&#39;</p><p style="white-space: normal;">&nbsp; --Restore FileListOnly from disk=&#39;D:\data\xx.bak&#39;</p><p style="white-space: normal;">&nbsp; ===================================================================================</p><p style="white-space: normal;">*/</p><p style="white-space: normal;">CREATE PROC Usp_RestoreDataBaseFormPath</p><p style="white-space: normal;">(@DatabBaseBakPath nvarchar(400),</p><p style="white-space: normal;">&nbsp;@RestoreDataPath nvarchar(400)=&#39;&#39;, &nbsp;--RESTORE DATABASE PATH&nbsp;</p><p style="white-space: normal;">&nbsp;@IsRun smallint=0 -- 0 PRINT &nbsp;1 run&nbsp;</p><p style="white-space: normal;">)&nbsp;</p><p style="white-space: normal;">AS</p><p style="white-space: normal;">BEGIN</p><p style="white-space: normal;">set nocount on</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">declare @dbname nvarchar(200),@SQL nvarchar(4000),@DirSQL nvarchar(1000),@errorinfo nvarchar(300)</p><p style="white-space: normal;">--add path \</p><p style="white-space: normal;">if (@RestoreDataPath is not null) and len(@RestoreDataPath)&gt;1&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp;and (right(@RestoreDataPath,1)&lt;&gt;&#39;\&#39;)</p><p style="white-space: normal;">&nbsp; &nbsp;set @RestoreDataPath=@RestoreDataPath+&#39;\&#39;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">declare @checkdrive int</p><p style="white-space: normal;">set @checkdrive=1</p><p style="white-space: normal;">&nbsp;exec master.dbo.Usp_Check_DriveExists @RestoreDataPath,@checkdrive output</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp;if(@checkdrive&lt;&gt;1)</p><p style="white-space: normal;">&nbsp; &nbsp; Goto ExitFLag&nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">DECLARE @BakFileList TABLE&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; ( &nbsp; &nbsp;LogicalName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,PhysicalName nvarchar(260)</p><p style="white-space: normal;">&nbsp; &nbsp; )</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">DECLARE @BakHeaderInfo TABLE</p><p style="white-space: normal;">&nbsp; &nbsp; (</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; DatabaseName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; )</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">if Charindex(&#39;Microsoft SQL Server 2008&#39;,@@VERSION)&gt;0</p><p style="white-space: normal;">&nbsp; begin</p><p style="white-space: normal;">&nbsp; &nbsp; --SQL Server 2008 &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; DECLARE @BakFileList2008 TABLE&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; ( &nbsp; &nbsp;LogicalName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,PhysicalName nvarchar(260)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,Type char(1)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FileGroupName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SIZE numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,MaxSize numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FileID bigint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CreateLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DropLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UniqueID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ReadOnlyLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ReadWriteLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupSizeInBytes bigint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SourceBlockSize int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FileGroupID int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,LogGroupGUID uniqueidentifier NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseGUID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsReadOnly bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsPresent bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,TDEThumbprint varbinary(32)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; ) &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp;&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp;INSERT INTO @BakFileList2008 &nbsp; &nbsp; &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;EXEC sp_executesql N&#39;Restore FileListOnly From Disk=@DatabBaseBakPath&#39;,N&#39;@DatabBaseBakPath nvarchar(260)&#39;,@DatabBaseBakPath&nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; DECLARE @BakHeaderInfo2008 TABLE</p><p style="white-space: normal;">&nbsp; &nbsp; (</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BackupName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupDescription nvarchar(255)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupType smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ExpirationDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,Compressed tinyint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,POSITION smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DeviceType tinyint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UserName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ServerName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseVersion int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseCreationDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupSize numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FirstLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,LastLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CheckpointLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseBackupLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupStartDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupFinishDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SortOrder smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CodePage smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UnicodeLocaleId int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UnicodeComparisonStyle int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CompatibilityLevel tinyint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVendorId int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVersionMajor int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVersionMinor int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVersionBuild int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,MachineName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,Flags int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BindingID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,RecoveryForkID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,COLLATION nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FamilyGUID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,HasBulkLoggedData bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsSnapshot bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsReadOnly bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsSingleUser bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,HasBackupChecksums bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsDamaged bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BeginsLogChain bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,HasIncompleteMetaData bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsForceOffline bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsCopyOnly bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FirstRecoveryForkID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ForkPointLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,RecoveryModel nvarchar(60)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseGUID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupTypeDescription nvarchar(60)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupSetGUID uniqueidentifier NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CompressedBackupSize numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; ) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; INSERT INTO @BakHeaderInfo2008 &nbsp; &nbsp; &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;EXEC sp_executesql N&#39;Restore HeaderOnly From Disk=@DatabBaseBakPath&#39;,N&#39;@DatabBaseBakPath nvarchar(260)&#39;,@DatabBaseBakPath&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp;&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; insert into @BakHeaderInfo(DatabaseName)</p><p style="white-space: normal;">&nbsp; &nbsp; select DatabaseName from @BakHeaderInfo2008</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; insert into @BakFileList(LogicalName ,PhysicalName)</p><p style="white-space: normal;">&nbsp; &nbsp; select &nbsp;LogicalName ,PhysicalName from @BakFileList2008</p><p style="white-space: normal;">&nbsp; end</p><p style="white-space: normal;">else</p><p style="white-space: normal;">&nbsp; begin</p><p style="white-space: normal;">&nbsp; &nbsp; --SQL Server 2005 &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; DECLARE @BakFileList2005 TABLE&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; (</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LogicalName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,PhysicalName nvarchar(260)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,Type char(1)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FileGroupName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SIZE numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,MaxSize numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FileID bigint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CreateLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DropLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UniqueID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ReadOnlyLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ReadWriteLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupSizeInBytes bigint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SourceBlockSize int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FileGroupID int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,LogGroupGUID uniqueidentifier NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseGUID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsReadOnly bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsPresent bit</p><p style="white-space: normal;">&nbsp; &nbsp; ) &nbsp; &nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; INSERT INTO @BakFileList2005 &nbsp; &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; EXEC sp_executesql N&#39;Restore FileListOnly From Disk=@DatabBaseBakPath&#39;,N&#39;@DatabBaseBakPath nvarchar(260)&#39;,@DatabBaseBakPath&nbsp;</p><p style="white-space: normal;">&nbsp;&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; DECLARE @BakHeaderInfo2005 TABLE&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; (</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BackupName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupDescription nvarchar(255)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupType smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ExpirationDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,Compressed tinyint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,POSITION smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DeviceType tinyint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UserName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ServerName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseVersion int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseCreationDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupSize numeric(20,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FirstLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,LastLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CheckpointLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DatabaseBackupLSN numeric(25,0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupStartDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupFinishDate datetime</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SortOrder smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CodePage smallint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UnicodeLocaleId int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,UnicodeComparisonStyle int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,CompatibilityLevel tinyint</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVendorId int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVersionMajor int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVersionMinor int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,SoftwareVersionBuild int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,MachineName nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,Flags int</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BindingID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,RecoveryForkID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,COLLATION nvarchar(128)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FamilyGUID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,HasBulkLoggedData bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsSnapshot bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsReadOnly bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsSingleUser bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,HasBackupChecksums bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsDamaged bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BeginsLogChain bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,HasIncompleteMetaData bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsForceOffline bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,IsCopyOnly bit</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,FirstRecoveryForkID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,ForkPointLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,RecoveryModel nvarchar(60)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseLSN numeric(25,0) NULL</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,DifferentialBaseGUID uniqueidentifier</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupTypeDescription nvarchar(60)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; ,BackupSetGUID uniqueidentifier NULL</p><p style="white-space: normal;">&nbsp; &nbsp; ) &nbsp; &nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; INSERT INTO @BakHeaderInfo2005 &nbsp; &nbsp; &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; EXEC sp_executesql N&#39;Restore HeaderOnly From Disk=@DatabBaseBakPath&#39;,N&#39;@DatabBaseBakPath nvarchar(260)&#39;,@DatabBaseBakPath&nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; insert into @BakHeaderInfo(DatabaseName)</p><p style="white-space: normal;">&nbsp; &nbsp; select DatabaseName from @BakHeaderInfo2005</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; insert into @BakFileList(LogicalName ,PhysicalName)</p><p style="white-space: normal;">&nbsp; &nbsp; select &nbsp;LogicalName ,PhysicalName from @BakFileList2005</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; end</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">--Check back file info</p><p style="white-space: normal;">if not exists (select 1 from @BakFileList) OR not exists (select 1 from @BakHeaderInfo)</p><p style="white-space: normal;">&nbsp;begin</p><p style="white-space: normal;">&nbsp; &nbsp;set @errorinfo=N&#39;取不到备份文件:&#39;+@DatabBaseBakPath+N&#39; 的信息，请检查备份文件是否正确或者版本是否兼容&#39;</p><p style="white-space: normal;">&nbsp; &nbsp;Raiserror 50001 @errorinfo &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp;Goto ExitFLag</p><p style="white-space: normal;">&nbsp;end</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">--Get DataBase Name</p><p style="white-space: normal;">SELECT TOP 1 @dbname=databasename FROM @BakHeaderInfo</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">if exists (select 1 from master.sys.databases with(nolock) where name=@dbname)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp;begin</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;set @errorinfo=N&#39;数据库：&#39;+@dbname+N&#39;已经存在，不能还原&#39;&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;Raiserror 50001 @errorinfo &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;Goto ExitFLag</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp;end</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">DECLARE @LogicalName nvarchar(200),@PhysicalName nvarchar(400)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;,@pos int ,@endpos int,@LastPhysicalName nvarchar(400)</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">DECLARE db_file CURSOR&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; LOCAL&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; READ_ONLY&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; FORWARD_ONLY&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; STATIC&nbsp;</p><p style="white-space: normal;">FOR</p><p style="white-space: normal;">&nbsp;SELECT&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp;LogicalName</p><p style="white-space: normal;">&nbsp; &nbsp; ,PhysicalName &nbsp;</p><p style="white-space: normal;">&nbsp;FROM @BakFileList</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">OPEN db_file</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">set @DirSQL=&#39;&#39;</p><p style="white-space: normal;">set @SQL=+N&#39;RESTORE DATABASE &#39;+QUOTENAME(@dbname)+&#39; from disk=N&#39;&#39;&#39;+@DatabBaseBakPath+&#39;&#39;&#39;&#39;</p><p style="white-space: normal;">set @SQL=@SQL+char(13)+Char(10)+N&#39; WITH FILE=1 &#39;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">FETCH NEXT FROM db_file INTO @LogicalName,@PhysicalName</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">WHILE @@FETCH_STATUS=0</p><p style="white-space: normal;">&nbsp;begin</p><p style="white-space: normal;">&nbsp; &nbsp;---Get DB PhysicalName</p><p style="white-space: normal;">&nbsp; &nbsp;set @endpos=0</p><p style="white-space: normal;">&nbsp; &nbsp;while CHARINDEX(&#39;\&#39;,@PhysicalName)&gt;0</p><p style="white-space: normal;">&nbsp; &nbsp; begin</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; set @pos=CHARINDEX(&#39;\&#39;,@PhysicalName,@endpos)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; if(@pos=0)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; set @endpos=@pos+1;</p><p style="white-space: normal;">&nbsp; &nbsp; end</p><p style="white-space: normal;">&nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp;--create new db path</p><p style="white-space: normal;">&nbsp; &nbsp;if(len(@RestoreDataPath)&gt;1)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; begin</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set @PhysicalName=@RestoreDataPath+@dbname+&#39;\&#39;+SUBSTRING(@PhysicalName,@endpos,LEN(@PhysicalName)-@endpos+1)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set @DirSQL=N&#39;EXEC master.sys.xp_create_subdir N&#39;&#39;&#39;+@RestoreDataPath+@dbname+&#39;&#39;&#39;&#39;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;END</p><p style="white-space: normal;">&nbsp; &nbsp; else</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; begin</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; if len(@DirSQL)&lt;1 OR (SUBSTRING(@PhysicalName,1,@endpos-1)&lt;&gt;@LastPhysicalName)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(len(@DirSQL)&lt;1)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set @DirSQL=N&#39;EXEC master.sys.xp_create_subdir N&#39;&#39;&#39;+SUBSTRING(@PhysicalName,1,@endpos-1)+&#39;&#39;&#39;&#39;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set @DirSQL=@DirSQL+char(13)+N&#39;EXEC master.sys.xp_create_subdir N&#39;&#39;&#39;+SUBSTRING(@PhysicalName,1,@endpos-1)+&#39;&#39;&#39;&#39;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---Check Drives</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set @checkdrive=1</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exec master.dbo.Usp_Check_DriveExists @PhysicalName,@checkdrive output</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(@checkdrive&lt;&gt;1)</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Goto ExitFLag&nbsp;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; &nbsp; set @LastPhysicalName=SUBSTRING(@PhysicalName,1,@endpos-1);</p><p style="white-space: normal;">&nbsp; &nbsp; &nbsp; END</p><p style="white-space: normal;">&nbsp; &nbsp;&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp; set @SQL=@SQL+char(13)+Char(10)+N&#39; ,Move N&#39;&#39;&#39;+@LogicalName+&#39;&#39;&#39;&#39;+&#39; TO N&#39;&#39;&#39;+@PhysicalName+&#39;&#39;&#39;&#39;</p><p style="white-space: normal;">&nbsp; &nbsp;&nbsp;</p><p style="white-space: normal;">&nbsp; &nbsp;FETCH NEXT FROM db_file INTO @LogicalName,@PhysicalName</p><p style="white-space: normal;">&nbsp;end</p><p style="white-space: normal;">&nbsp;set @SQL=@SQL+char(13)+Char(10)+N&#39; ,NOUNLOAD,Recovery,STATS = 10&#39;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">if(@IsRun=0)</p><p style="white-space: normal;">&nbsp; &nbsp; print( @DirSQL+char(13)+char(10)+&#39;GO&#39;+char(13)+Char(10)+@SQL+char(13))</p><p style="white-space: normal;">else</p><p style="white-space: normal;">&nbsp;begin</p><p style="white-space: normal;">&nbsp; print(&#39;-----------Begin Restore Database:&#39;+@dbname+&#39;------------------&#39;)</p><p style="white-space: normal;">&nbsp; exec(@DirSQL)</p><p style="white-space: normal;">&nbsp; exec(@SQL)</p><p style="white-space: normal;">&nbsp; print(&#39;-----------End Restore Database:&#39;+@dbname+&#39;---------------------&#39;+char(13))</p><p style="white-space: normal;">&nbsp;end</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">&nbsp;close db_file</p><p style="white-space: normal;">&nbsp;deallocate db_file</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">ExitFLag:</p><p style="white-space: normal;">set nocount off</p><p style="white-space: normal;">end</p><p style="white-space: normal;"><br/></p>