<p>/*============================================================================</p><p>&nbsp; File: &nbsp; &nbsp; sp_SQLskills_SQL2008_finddupes.sql</p><p><br/></p><p>&nbsp; Summary: &nbsp;Run against a single database this procedure will list ALL</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; duplicate indexes and the needed TSQL to drop them!</p><p><span class="Apple-tab-span" style="white-space:pre">					</span></p><p>&nbsp; Date: &nbsp; &nbsp; July 2011</p><p><br/></p><p>&nbsp; SQL Server 2008 Version</p><p>------------------------------------------------------------------------------</p><p>&nbsp; Written by Kimberly L. Tripp, SYSolutions, Inc.</p><p><br/></p><p>&nbsp; For more scripts and sample code, check out&nbsp;</p><p>&nbsp; &nbsp; http://www.SQLskills.com</p><p><br/></p><p>&nbsp; This script is intended only as a supplement to demos and lectures</p><p>&nbsp; given by SQLskills instructors. &nbsp;</p><p>&nbsp;&nbsp;</p><p>&nbsp; THIS CODE AND INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT WARRANTY OF&nbsp;</p><p>&nbsp; ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED&nbsp;</p><p>&nbsp; TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A</p><p>&nbsp; PARTICULAR PURPOSE.</p><p>============================================================================*/</p><p><br/></p><p>USE master</p><p>go</p><p><br/></p><p>if OBJECTPROPERTY(OBJECT_ID(&#39;sp_SQLskills_SQL2008_finddupes&#39;), &#39;IsProcedure&#39;) = 1</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>drop procedure sp_SQLskills_SQL2008_finddupes</p><p>go</p><p><br/></p><p>SET ANSI_NULLS ON</p><p>GO</p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p><br/></p><p>CREATE PROCEDURE [dbo].[sp_SQLskills_SQL2008_finddupes]</p><p>(</p><p>&nbsp; &nbsp; @ObjName nvarchar(776) = NULL<span class="Apple-tab-span" style="white-space:pre">		</span>-- the table to check for duplicates</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- when NULL it will check ALL tables</p><p>)</p><p>AS</p><p><br/></p><p>-- &nbsp;Jul 2011: V1 to find duplicate indexes.</p><p><br/></p><p>-- See my blog for updates and/or additional information</p><p>-- http://www.SQLskills.com/blogs/Kimberly (Kimberly L. Tripp)</p><p><br/></p><p>SET NOCOUNT ON</p><p><br/></p><p>DECLARE @ObjID int,<span class="Apple-tab-span" style="white-space:pre">			</span>-- the object id of the table</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>@DBName<span class="Apple-tab-span" style="white-space:pre">	</span>sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>@SchemaName sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>@TableName sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>@ExecStr nvarchar(4000)</p><p><br/></p><p>-- Check to see that the object names are local to the current database.</p><p>SELECT @DBName = PARSENAME(@ObjName,3)</p><p><br/></p><p>IF @DBName IS NULL</p><p>&nbsp; &nbsp; SELECT @DBName = db_name()</p><p>ELSE&nbsp;</p><p>IF @DBName &lt;&gt; db_name()</p><p>&nbsp; &nbsp; BEGIN</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;RAISERROR(15250,-1,-1)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;-- select * from sys.messages where message_id = 15250</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;RETURN (1)</p><p>&nbsp; &nbsp; END</p><p><br/></p><p>IF @DBName = N&#39;tempdb&#39;</p><p>&nbsp; &nbsp; BEGIN</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;RAISERROR(&#39;WARNING: This procedure cannot be run against tempdb. Skipping tempdb.&#39;, 10, 0)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;RETURN (1)</p><p>&nbsp; &nbsp; END</p><p><br/></p><p>-- Check to see the the table exists and initialize @ObjID.</p><p>SELECT @SchemaName = PARSENAME(@ObjName, 2)</p><p><br/></p><p>IF @SchemaName IS NULL</p><p>&nbsp; &nbsp; SELECT @SchemaName = SCHEMA_NAME()</p><p><br/></p><p>-- Check to see the the table exists and initialize @ObjID.</p><p>IF @ObjName IS NOT NULL</p><p>BEGIN</p><p>&nbsp; &nbsp; SELECT @ObjID = object_id(@ObjName)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p>&nbsp; &nbsp; IF @ObjID is NULL</p><p>&nbsp; &nbsp; BEGIN</p><p>&nbsp; &nbsp; &nbsp; &nbsp; RAISERROR(15009,-1,-1,@ObjName,@DBName)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; -- select * from sys.messages where message_id = 15009</p><p>&nbsp; &nbsp; &nbsp; &nbsp; RETURN (1)</p><p>&nbsp; &nbsp; END</p><p>END</p><p><br/></p><p><br/></p><p>CREATE TABLE #DropIndexes</p><p>(</p><p>&nbsp; &nbsp; DatabaseName &nbsp; &nbsp;sysname,</p><p>&nbsp; &nbsp; SchemaName &nbsp; &nbsp; &nbsp;sysname,</p><p>&nbsp; &nbsp; TableName &nbsp; &nbsp; &nbsp; sysname,</p><p>&nbsp; &nbsp; IndexName &nbsp; &nbsp; &nbsp; sysname,</p><p>&nbsp; &nbsp; DropStatement &nbsp; nvarchar(2000)</p><p>)</p><p><br/></p><p>CREATE TABLE #FindDupes</p><p>(</p><p>&nbsp; &nbsp; index_id int,</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>is_disabled bit,</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>index_name sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>index_description varchar(210),</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>index_keys nvarchar(2126),</p><p>&nbsp; &nbsp; included_columns nvarchar(max),</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>filter_definition nvarchar(max),</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>columns_in_tree nvarchar(2126),</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>columns_in_leaf nvarchar(max)</p><p>)</p><p><br/></p><p>-- OPEN CURSOR OVER TABLE(S)</p><p>IF @ObjName IS NOT NULL</p><p>&nbsp; &nbsp; DECLARE TableCursor CURSOR LOCAL STATIC FOR</p><p>&nbsp; &nbsp; &nbsp; &nbsp; SELECT @SchemaName, PARSENAME(@ObjName, 1)</p><p>ELSE</p><p>&nbsp; &nbsp; DECLARE TableCursor CURSOR LOCAL STATIC FOR <span class="Apple-tab-span" style="white-space:pre">		</span> &nbsp; &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; SELECT schema_name(uid), name&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; FROM sysobjects&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; WHERE type = &#39;U&#39; --AND name</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ORDER BY schema_name(uid), name</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;</p><p>OPEN TableCursor&nbsp;</p><p><br/></p><p>FETCH TableCursor</p><p>&nbsp; &nbsp; INTO @SchemaName, @TableName</p><p><br/></p><p>-- For each table, list the add the duplicate indexes and save&nbsp;</p><p>-- the info in a temporary table that we&#39;ll print out at the end.</p><p><br/></p><p>WHILE @@fetch_status &gt;= 0</p><p>BEGIN</p><p>&nbsp; &nbsp; TRUNCATE TABLE #FindDupes</p><p>&nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; SELECT @ExecStr = &#39;EXEC sp_SQLskills_SQL2008_finddupes_helpindex &#39;&#39;&#39;&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + QUOTENAME(@SchemaName)&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + N&#39;.&#39;&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + QUOTENAME(@TableName)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + N&#39;&#39;&#39;&#39;</p><p><br/></p><p>&nbsp; &nbsp; --SELECT @ExecStr</p><p><br/></p><p>&nbsp; &nbsp; INSERT #FindDupes</p><p>&nbsp; &nbsp; EXEC (@ExecStr)<span class="Apple-tab-span" style="white-space:pre">	</span></p><p>&nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; --SELECT * FROM #FindDupes</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p>&nbsp; &nbsp; INSERT #DropIndexes</p><p>&nbsp; &nbsp; SELECT DISTINCT @DBName,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @SchemaName,&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @TableName,&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t1.index_name,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; N&#39;DROP INDEX &#39;&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + QUOTENAME(@SchemaName, N&#39;]&#39;)&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + N&#39;.&#39;&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + QUOTENAME(@TableName, N&#39;]&#39;)&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + N&#39;.&#39;&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + t1.index_name&nbsp;</p><p>&nbsp; &nbsp; FROM #FindDupes AS t1</p><p>&nbsp; &nbsp; &nbsp; &nbsp; JOIN #FindDupes AS t2</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ON t1.columns_in_tree = t2.columns_in_tree</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND t1.columns_in_leaf = t2.columns_in_leaf&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND ISNULL(t1.filter_definition, 1) = ISNULL(t2.filter_definition, 1)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND PATINDEX(&#39;%unique%&#39;, t1.index_description) = PATINDEX(&#39;%unique%&#39;, t2.index_description)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND t1.index_id &gt; t2.index_id</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; FETCH TableCursor</p><p>&nbsp; &nbsp; &nbsp; &nbsp; INTO @SchemaName, @TableName</p><p>END</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p>DEALLOCATE TableCursor</p><p><br/></p><p>-- DISPLAY THE RESULTS</p><p><br/></p><p>IF (SELECT count(*) FROM #DropIndexes) = 0</p><p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp;RAISERROR(&#39;Database: %s has NO duplicate indexes.&#39;, 10, 0, @DBName)</p><p>ELSE</p><p>&nbsp; &nbsp; SELECT * FROM #DropIndexes</p><p>&nbsp; &nbsp; ORDER BY SchemaName, TableName</p><p><br/></p><p>return (0) -- sp_SQLskills_SQL2008_finddupes</p><p>go</p><p><br/></p><p>exec sys.sp_MS_marksystemobject &#39;sp_SQLskills_SQL2008_finddupes&#39;</p><p>go</p><p><br/></p>