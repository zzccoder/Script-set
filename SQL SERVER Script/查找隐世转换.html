<p></p><p>--====================================================================</p><p>--查看指定数据库下发生的隐式转换</p><p>--来源：http://sqlblog.com/blogs/jonathan_kehayias/archive/2010/01/08/finding-implicit-column-conversions-in-the-plan-cache.aspx</p><p>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED&nbsp;</p><p><br/></p><p>DECLARE @dbname SYSNAME&nbsp;</p><p>SET @dbname = QUOTENAME(DB_NAME());&nbsp;</p><p><br/></p><p>WITH XMLNAMESPACES&nbsp;</p><p>&nbsp; &nbsp;(DEFAULT &#39;http://schemas.microsoft.com/sqlserver/2004/07/showplan&#39;)&nbsp;</p><p>SELECT&nbsp;</p><p>&nbsp; &nbsp;stmt.value(&#39;(@StatementText)[1]&#39;, &#39;varchar(max)&#39;) AS SQL_Text,&nbsp;</p><p>&nbsp; &nbsp;t.value(&#39;(ScalarOperator/Identifier/ColumnReference/@Schema)[1]&#39;, &#39;varchar(128)&#39;) AS SchemaName,&nbsp;</p><p>&nbsp; &nbsp;t.value(&#39;(ScalarOperator/Identifier/ColumnReference/@Table)[1]&#39;, &#39;varchar(128)&#39;) AS TableName,&nbsp;</p><p>&nbsp; &nbsp;t.value(&#39;(ScalarOperator/Identifier/ColumnReference/@Column)[1]&#39;, &#39;varchar(128)&#39;) AS ColumnName,&nbsp;</p><p>&nbsp; &nbsp;ic.DATA_TYPE AS ConvertFrom,&nbsp;</p><p>&nbsp; &nbsp;ic.CHARACTER_MAXIMUM_LENGTH AS ConvertFromLength,&nbsp;</p><p>&nbsp; &nbsp;t.value(&#39;(@DataType)[1]&#39;, &#39;varchar(128)&#39;) AS ConvertTo,&nbsp;</p><p>&nbsp; &nbsp;t.value(&#39;(@Length)[1]&#39;, &#39;int&#39;) AS ConvertToLength,&nbsp;</p><p>&nbsp; &nbsp;query_plan&nbsp;</p><p>FROM sys.dm_exec_cached_plans AS cp&nbsp;</p><p>CROSS APPLY sys.dm_exec_query_plan(plan_handle) AS qp&nbsp;</p><p>CROSS APPLY query_plan.nodes(&#39;/ShowPlanXML/BatchSequence/Batch/Statements/StmtSimple&#39;) AS batch(stmt)&nbsp;</p><p>CROSS APPLY stmt.nodes(&#39;.//Convert[@Implicit=&quot;1&quot;]&#39;) AS n(t)&nbsp;</p><p>JOIN INFORMATION_SCHEMA.COLUMNS AS ic&nbsp;</p><p>&nbsp; &nbsp;ON QUOTENAME(ic.TABLE_SCHEMA) = t.value(&#39;(ScalarOperator/Identifier/ColumnReference/@Schema)[1]&#39;, &#39;varchar(128)&#39;)&nbsp;</p><p>&nbsp; &nbsp;AND QUOTENAME(ic.TABLE_NAME) = t.value(&#39;(ScalarOperator/Identifier/ColumnReference/@Table)[1]&#39;, &#39;varchar(128)&#39;)&nbsp;</p><p>&nbsp; &nbsp;AND ic.COLUMN_NAME = t.value(&#39;(ScalarOperator/Identifier/ColumnReference/@Column)[1]&#39;, &#39;varchar(128)&#39;)&nbsp;</p><p>WHERE t.exist(&#39;ScalarOperator/Identifier/ColumnReference[@Database=sql:variable(&quot;@dbname&quot;)][@Schema!=&quot;[sys]&quot;]&#39;) = 1</p>