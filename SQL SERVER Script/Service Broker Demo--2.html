<p style="white-space: normal;">--======================================================================</p><p style="white-space: normal;">--在服务器B上执行</p><p>--===============================================================================</p><p>--Step 2</p><p>--===========================================================================</p><p>--========================================================================</p><p>--Create endpoint with windows authentication</p><p>--========================================================================</p><p>USE master;</p><p>GO</p><p>IF EXISTS (SELECT * FROM sys.endpoints</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE name = N&#39;InstInitiatorEndpoint&#39;)</p><p>&nbsp; &nbsp; &nbsp;DROP ENDPOINT InstInitiatorEndpoint;</p><p>GO</p><p>CREATE ENDPOINT InstInitiatorEndpoint</p><p>STATE = STARTED</p><p>AS TCP ( LISTENER_PORT = 4022 )</p><p>FOR SERVICE_BROKER (AUTHENTICATION = WINDOWS );</p><p>GO</p><p><br/></p><p>--========================================================================</p><p>--Create Initiator database InstInitiatorDB</p><p>--========================================================================</p><p>USE master;</p><p>GO</p><p>IF EXISTS (SELECT * FROM sys.databases</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE name = N&#39;InstTargetDB&#39;)</p><p>&nbsp; &nbsp; &nbsp;DROP DATABASE InstInitiatorDB;</p><p>GO</p><p>CREATE DATABASE InstInitiatorDB;</p><p>GO</p><p>USE InstInitiatorDB;</p><p>GO</p><p>CREATE MASTER KEY</p><p>&nbsp; &nbsp; &nbsp; &nbsp;ENCRYPTION BY PASSWORD = N&#39;Auto@sql&#39;;</p><p>GO</p><p>CREATE USER InitiatorUser WITHOUT LOGIN;</p><p>GO</p><p>--======================================================================================</p><p>--Create certification and backup it</p><p>--======================================================================================</p><p>USE InstInitiatorDB</p><p>GO</p><p>CREATE CERTIFICATE InstInitiatorCertificate&nbsp;</p><p>&nbsp; &nbsp; &nbsp;AUTHORIZATION InitiatorUser</p><p>&nbsp; &nbsp; &nbsp;WITH SUBJECT = &#39;Target Certificate&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EXPIRY_DATE = N&#39;12/31/2012&#39;;</p><p>GO</p><p>BACKUP CERTIFICATE InstInitiatorCertificate</p><p>&nbsp; TO FILE =&nbsp;</p><p>N&#39;\\Ms-wengao-02\cert\InstInitiatorCertificate.cer&#39;;</p><p>GO</p><p><br/></p><p>--======================================================================================</p><p>--Create message type,contract,queue,services</p><p>--======================================================================================</p><p>USE InstInitiatorDB</p><p>GO</p><p>CREATE MESSAGE TYPE [//BothDB/2InstSample/RequestMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp;VALIDATION = WELL_FORMED_XML;</p><p>CREATE MESSAGE TYPE [//BothDB/2InstSample/ReplyMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp;VALIDATION = WELL_FORMED_XML;</p><p>GO</p><p>CREATE CONTRACT [//BothDB/2InstSample/SimpleContract]</p><p>&nbsp; &nbsp; &nbsp; ([//BothDB/2InstSample/RequestMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SENT BY INITIATOR,</p><p>&nbsp; &nbsp; &nbsp; &nbsp;[//BothDB/2InstSample/ReplyMessage]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SENT BY TARGET</p><p>&nbsp; &nbsp; &nbsp; );</p><p>GO</p><p>CREATE QUEUE InstInitiatorQueue;</p><p>GO</p><p>CREATE SERVICE [//InstDB/2InstSample/InitiatorService]</p><p>&nbsp; &nbsp; &nbsp; &nbsp;AUTHORIZATION InitiatorUser</p><p>&nbsp; &nbsp; &nbsp; &nbsp;ON QUEUE InstInitiatorQueue;</p><p>GO</p><p><br/></p><p>--======================================================================================</p><p>--Create user TargetUser</p><p>--Use the certificate which create by traget to Create cetificate</p><p>--======================================================================================</p><p>USE InstInitiatorDB</p><p>CREATE USER TargetUser WITHOUT LOGIN;</p><p>GO</p><p>CREATE CERTIFICATE InstTargetCertificate&nbsp;</p><p>&nbsp; &nbsp;AUTHORIZATION TargetUser</p><p>&nbsp; &nbsp;FROM FILE =&nbsp;</p><p>N&#39;\\Ms-wengao-02\cert\InstTargetCertificate.cer&#39;</p><p>GO</p><p>--======================================================================================</p><p>--Create route and remote service binding</p><p>--======================================================================================</p><p>USE InstInitiatorDB</p><p>GO</p><p>CREATE ROUTE InstTargetRoute</p><p>WITH SERVICE_NAME = N&#39;//TgtDB/2InstSample/TargetService&#39;,</p><p>ADDRESS = &#39;TCP://172.22.101.214:4022&#39;;</p><p>USE msdb;</p><p>GO</p><p>CREATE ROUTE InstInitiatorRoute</p><p>WITH SERVICE_NAME = N&#39;//InstDB/2InstSample/InitiatorService&#39;,</p><p>&nbsp; &nbsp; &nbsp;ADDRESS = N&#39;TCP://172.22.101.96:4022&#39;;</p><p>GO</p><p>CREATE REMOTE SERVICE BINDING TargetBinding</p><p>TO SERVICE N&#39;//TgtDB/2InstSample/TargetService&#39;</p><p>WITH USER = TargetUser;</p><p>GO</p><p><br/></p><p>--================================================================================</p><p>--Step 4</p><p>--================================================================================</p><p>--======================================================================================</p><p>--Start conversation</p><p>--======================================================================================</p><p>USE InstInitiatorDB;</p><p>GO</p><p>DECLARE @InitDlgHandle UNIQUEIDENTIFIER;</p><p>DECLARE @RequestMsg NVARCHAR(100);</p><p><br/></p><p>BEGIN TRANSACTION;</p><p><br/></p><p>BEGIN DIALOG @InitDlgHandle</p><p>&nbsp; &nbsp; &nbsp;FROM SERVICE [//InstDB/2InstSample/InitiatorService]</p><p>&nbsp; &nbsp; &nbsp;TO SERVICE N&#39;//TgtDB/2InstSample/TargetService&#39;</p><p>&nbsp; &nbsp; &nbsp;ON CONTRACT [//BothDB/2InstSample/SimpleContract]</p><p>&nbsp; &nbsp; &nbsp;WITH</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ENCRYPTION = ON;</p><p><br/></p><p>SELECT @RequestMsg = N&#39;&lt;RequestMsg&gt;Message for Target service.&lt;/RequestMsg&gt;&#39;;</p><p><br/></p><p>SEND ON CONVERSATION @InitDlgHandle</p><p>&nbsp; &nbsp; &nbsp;MESSAGE TYPE [//BothDB/2InstSample/RequestMessage]</p><p>&nbsp; &nbsp; &nbsp;(@RequestMsg);</p><p><br/></p><p>SELECT @RequestMsg AS SentRequestMsg;</p><p><br/></p><p>COMMIT TRANSACTION;</p><p>GO</p><p>--===============================================================================</p><p>--Step 6</p><p>--===============================================================================</p><p>USE InstInitiatorDB;</p><p>GO</p><p>DECLARE @RecvReplyMsg NVARCHAR(100);</p><p>DECLARE @RecvReplyDlgHandle UNIQUEIDENTIFIER;</p><p><br/></p><p>BEGIN TRANSACTION;</p><p><br/></p><p>WAITFOR</p><p>( RECEIVE TOP(1)</p><p>&nbsp; &nbsp; @RecvReplyDlgHandle = conversation_handle,</p><p>&nbsp; &nbsp; @RecvReplyMsg = message_body</p><p>&nbsp; FROM InstInitiatorQueue</p><p>), TIMEOUT 1000;</p><p><br/></p><p>END CONVERSATION @RecvReplyDlgHandle;</p><p><br/></p><p>-- Display recieved request.</p><p>SELECT @RecvReplyMsg AS ReceivedReplyMsg;</p><p><br/></p><p>COMMIT TRANSACTION;</p><p>GO</p>