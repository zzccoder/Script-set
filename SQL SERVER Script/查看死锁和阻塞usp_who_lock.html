<p></p><p>USE [master]</p><p>GO</p><p><br/></p><p>/****** Object: &nbsp;StoredProcedure [dbo].[sp_who_lock] &nbsp; &nbsp;Script Date: 02/07/2014 11:51:24 ******/</p><p>SET ANSI_NULLS ON</p><p>GO</p><p><br/></p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p><br/></p><p>CREATE PROCEDURE [dbo].[usp_who_lock]</p><p>AS</p><p>BEGIN</p><p>DECLARE @spid INT,@bl INT,</p><p>@intTransactionCountOnEntry INT,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; @intRowcount &nbsp; &nbsp;INT,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; @intCountProperties &nbsp; INT,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; @intCounter &nbsp; &nbsp;INT</p><p><br/></p><p>CREATE TABLE #tmp_lock_who (</p><p>id INT IDENTITY(1,1),</p><p>SPID SMALLINT,</p><p>bl SMALLINT)</p><p><br/></p><p>IF @@ERROR&lt;&gt;0 RETURN @@ERROR</p><p><br/></p><p>INSERT INTO #tmp_lock_who(SPID,bl) SELECT 0 ,blocked</p><p>&nbsp; &nbsp;FROM (SELECT * FROM sysprocesses WHERE blocked&gt;0 ) a&nbsp;</p><p>&nbsp; &nbsp;WHERE NOT EXISTS(SELECT * FROM (SELECT * FROM sysprocesses WHERE blocked&gt;0 ) b&nbsp;</p><p>&nbsp; &nbsp;WHERE a.blocked=SPID)</p><p>&nbsp; &nbsp;UNION SELECT SPID,blocked FROM sysprocesses WHERE blocked&gt;0</p><p><br/></p><p>IF @@ERROR&lt;&gt;0 RETURN @@ERROR&nbsp;</p><p><br/></p><p>-- 找到临时表的记录数</p><p>SELECT @intCountProperties = COUNT(*),@intCounter = 1</p><p>FROM #tmp_lock_who</p><p><br/></p><p>IF @@ERROR&lt;&gt;0 RETURN @@ERROR&nbsp;</p><p><br/></p><p>IF @intCountProperties=0</p><p>SELECT &#39;现在没有阻塞和死锁信息&#39; AS MESSAGE</p><p><br/></p><p>-- 循环开始</p><p>WHILE @intCounter &lt;= @intCountProperties</p><p>BEGIN</p><p>-- 取第一条记录</p><p>SELECT @spid = SPID,@bl = bl</p><p>FROM #tmp_lock_who WHERE Id = @intCounter&nbsp;</p><p>BEGIN</p><p>IF @spid =0&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SELECT &#39;引起数据库死锁的是: &#39;+ CAST(@bl AS VARCHAR(10)) + &#39;进程号,其执行的SQL语法如下&#39;</p><p>ELSE</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SELECT &#39;进程号SPID：&#39;+ CAST(@spid AS VARCHAR(10))+ &#39;被&#39; + &#39;进程号SPID：&#39;+ CAST(@bl AS VARCHAR(10)) +&#39;阻塞,其当前进程执行的SQL语法如下&#39;</p><p>DBCC INPUTBUFFER (@bl )</p><p>IF @spid&gt;0</p><p>DBCC INPUTBUFFER (@spid )</p><p>END&nbsp;</p><p><br/></p><p>-- 循环指针下移</p><p>SET @intCounter = @intCounter + 1</p><p>END</p><p><br/></p><p>DROP TABLE #tmp_lock_who</p><p><br/></p><p>RETURN 0</p><p>END</p><p>GO</p><p><br/></p><p><br/></p><p>--===============================</p><p>--Usage</p><p>EXEC [master].[dbo].[usp_who_lock]</p>