<p>USE tempdb</p><p>GO</p><p>IF(OBJECT_ID(&#39;tempdb.dbo.usp_GetTempDBUsedSpace&#39;) IS NOT NULL)</p><p>BEGIN</p><p>DROP PROCEDURE tempdb.dbo.usp_GetTempDBUsedSpace</p><p>END</p><p>GO</p><p><br/></p><p>/****** Object: &nbsp;StoredProcedure [dbo].[usp_GetTempDBUsedSpace] &nbsp; &nbsp;Script Date: 03/05/2014 13:24:42 ******/</p><p>SET ANSI_NULLS ON</p><p>GO</p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p>-- =============================================</p><p>-- Author: SQL SERVER DMVS IN ACTIONS</p><p>-- Create date:&nbsp;</p><p>-- Description: &nbsp; &nbsp;查看Tempdb数据库的空间使用情况</p><p>-- =============================================</p><p>CREATE PROCEDURE [dbo].[usp_GetTempDBUsedSpace]</p><p>AS</p><p>BEGIN</p><p><br/></p><p>SET NOCOUNT ON;</p><p>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</p><p>--==========================================================</p><p><br/></p><p>SELECT N&#39;查看tempdb数据文件&#39;</p><p>EXEC(&#39;</p><p>USE tempdb;</p><p>DBCC showfilestats</p><p>&#39;)</p><p>--==========================================================</p><p><br/></p><p>SELECT N&#39;查看tempdb日志&#39;</p><p><br/></p><p>DECLARE @T TABLE</p><p>(</p><p>DatabaseName NVARCHAR(200),</p><p>[LoginSize(MB)] FLOAT,</p><p>[LogSpceUsed(%)] FLOAT,</p><p>[Status] INT</p><p>)</p><p>INSERT INTO @T([DatabaseName],[LoginSize(MB)],[LogSpceUsed(%)],[Status])</p><p>EXEC(&#39;DBCC SQLPERF (LOGSPACE)&#39;)</p><p>SELECT * FROM @T T</p><p>WHERE T.DatabaseName=&#39;tempdb&#39;</p><p><br/></p><p>--==========================================================</p><p><br/></p><p>SELECT N&#39;查看Tempdb数据库的空间使用情况&#39;</p><p>SELECT SUM(user_object_reserved_page_count&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + internal_object_reserved_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + version_store_reserved_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + mixed_extent_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + unallocated_extent_page_count) * (8.0/1024.0)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AS [TotalSizeOfTempDB(MB)]</p><p>&nbsp; &nbsp; , SUM(user_object_reserved_page_count&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + internal_object_reserved_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + version_store_reserved_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + mixed_extent_page_count) * (8.0/1024.0)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AS [UsedSpace (MB)]</p><p>&nbsp; &nbsp; , SUM(unallocated_extent_page_count * (8.0/1024.0))&nbsp;</p><p>AS [FreeSpace (MB)],</p><p>SUM(USER_object_reserved_page_count) * 8.0/1024 &nbsp;AS user_object_MB ,</p><p>SUM(internal_object_reserved_page_count) * 8.0/1024 &nbsp;AS internal_object_MB ,</p><p>SUM(version_store_reserved_page_count) * 8.0/1024 AS version_store_MB&nbsp;</p><p>FROM sys.dm_db_file_space_usage</p><p><br/></p><p>--==========================================================</p><p><br/></p><p>SELECT N&#39;查看每个会话在tempdb数据库上的空间使用&#39;</p><p>SELECT &nbsp;CAST(SUM(su.user_objects_alloc_page_count&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; + su.internal_objects_alloc_page_count) * (8.0/1024.0)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AS DECIMAL(20,3)) AS [SpaceUsed(MB)]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , CAST(SUM(su.user_objects_alloc_page_count&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - su.user_objects_dealloc_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + su.internal_objects_alloc_page_count&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - &nbsp;su.internal_objects_dealloc_page_count)&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * (8.0/1024.0) AS DECIMAL(20,3)) AS [SpaceStillUsed(MB)]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ,SUM(su.user_objects_alloc_page_count) AS user_objects_alloc_page_count&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ,SUM(su.user_objects_dealloc_page_count) AS user_objects_dealloc_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ,SUM(su.internal_objects_alloc_page_count) AS internal_objects_alloc_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ,SUM(su.internal_objects_dealloc_page_count) AS internal_objects_dealloc_page_count</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , su.session_id</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , ec.connection_id</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , es.login_name</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;, es.host_name</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , st.text AS [LastQuery]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , ec.last_read</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , ec.last_write</p><p>&nbsp; &nbsp; &nbsp; &nbsp; , es.program_name</p><p>FROM sys.dm_db_session_space_usage su&nbsp;</p><p>INNER JOIN sys.dm_exec_sessions es ON su.session_id = es.session_id&nbsp;</p><p>LEFT OUTER JOIN sys.dm_exec_connections ec&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ON su.session_id = ec.most_recent_session_id&nbsp;</p><p>OUTER APPLY sys.dm_exec_sql_text(ec.most_recent_sql_handle) st&nbsp;</p><p>WHERE su.session_id &gt; 50&nbsp;</p><p>GROUP BY su.session_id, ec.connection_id, es.login_name, es.host_name</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;, st.text, ec.last_read, ec.last_write, es.program_name&nbsp;</p><p>ORDER BY [SpaceStillUsed(MB)] DESC</p><p><br/></p><p>--==========================================================</p><p><br/></p><p><br/></p><p>END</p><p><br/></p><p>--=======================================================</p><p>--Demo</p><p><br/></p><p>EXEC&nbsp;tempdb.dbo.usp_GetTempDBUsedSpace</p><p><br/></p><p><br/></p>