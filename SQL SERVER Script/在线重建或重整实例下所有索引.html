<p>USE [master]</p><p>GO</p><p><br/></p><p>/****** Object: &nbsp;StoredProcedure [dbo].[usp_auto_indexdefrag_online] &nbsp; &nbsp;Script Date: 02/07/2014 11:44:55 ******/</p><p>SET ANSI_NULLS ON</p><p>GO</p><p><br/></p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p><br/></p><p>CREATE &nbsp;PROCEDURE [dbo].[usp_auto_indexdefrag_online]</p><p>AS</p><p><br/></p><p>BEGIN</p><p>SET NOCOUNT ON</p><p>&nbsp;DECLARE @Db_name NVARCHAR(256)</p><p>&nbsp; &nbsp;,@SchemaName NVARCHAR(256)</p><p>&nbsp; &nbsp;,@TableName NVARCHAR(256)</p><p>&nbsp; &nbsp;,@IndexName NVARCHAR(512)</p><p>&nbsp; &nbsp;,@PctFrag DECIMAL</p><p>&nbsp; &nbsp;,@Defrag NVARCHAR(MAX)</p><p>&nbsp; &nbsp;</p><p>&nbsp; &nbsp; IF EXISTS(SELECT 1 FROM sys.objects WHERE OBJECT_ID =OBJECT_ID(N&#39;#tmp&#39;)) DROP TABLE #tmp;</p><p>&nbsp; &nbsp; IF EXISTS(SELECT 1 FROM sys.objects WHERE OBJECT_ID =OBJECT_ID(N&#39;#tmp_sub&#39;)) DROP TABLE #tmp_sub;</p><p>&nbsp; &nbsp;&nbsp;</p><p>CREATE TABLE #tmp_sub(database_id INT,dbname NVARCHAR(32),tablename NVARCHAR(128),index_type_desc NVARCHAR(128))</p><p>CREATE TABLE #tmp(database_id INT,dbname NVARCHAR(256),tablename NVARCHAR(256),indexname NVARCHAR(256),type_desc NVARCHAR(128),schemaname NVARCHAR(256),avgfragment DECIMAL)</p><p><br/></p><p>------找出 &nbsp;text、ntext、image、varchar(max)、nvarchar(max)、varbinary(max)、xml 或大型 CLR 类型的列</p><p><br/></p><p>EXEC sp_MSforeachdb &#39;insert into #tmp_sub(database_id,dbname,tablename,index_type_desc)</p><p>select distinct c.database_id,&#39;&#39;?&#39;&#39; dbname,b.name,&#39;&#39;CLUSTERED&#39;&#39;</p><p>&nbsp;from&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;?.sys.dm_db_index_physical_stats(DB_ID(&#39;&#39;?&#39;&#39;),NULL,NULL,NULL,&#39;&#39;SAMPLED&#39;&#39;) as a</p><p>&nbsp; &nbsp; join ?.sys.tables as b on a.object_id=b.object_id&nbsp;</p><p>&nbsp; &nbsp; join sys.databases as c on a.database_id=c.database_id</p><p>&nbsp; &nbsp; join ?.sys.all_columns d on d.object_id =a.object_id&nbsp;</p><p>&nbsp; &nbsp; join ?.sys.sysobjects e on d.object_id=e.id and e.xtype=&#39;&#39;U&#39;&#39;&nbsp;</p><p>&nbsp; &nbsp; join ?.sys.types f on d.user_type_id=f.user_type_id&nbsp;</p><p>where &nbsp;b.type_desc=&#39;&#39;USER_TABLE&#39;&#39; and b.is_ms_shipped=0 and (d.max_length =-1</p><p>&nbsp; &nbsp; OR (f.name in (&#39;&#39;image&#39;&#39;,&#39;&#39;text&#39;&#39;,&#39;&#39;ntext&#39;&#39;,&#39;&#39;xml&#39;&#39;,&#39;&#39;varbinary&#39;&#39;,&#39;&#39;binary&#39;&#39;)))&#39;</p><p>&nbsp; &nbsp;&nbsp;</p><p>----找出 所有库中的索引</p><p><br/></p><p>EXEC sp_MSforeachdb &#39;insert into #tmp(database_id,dbname,tablename,indexname,type_desc,schemaname,avgfragment)</p><p>select &nbsp;distinct d.database_id,&#39;&#39;?&#39;&#39; dbname,c.name,b.name,b.type_desc,e.name,a.avg_fragmentation_in_percent&nbsp;</p><p>from ?.sys.dm_db_index_physical_stats(DB_ID(&#39;&#39;?&#39;&#39;),NULL,NULL,NULL,&#39;&#39;SAMPLED&#39;&#39;) as a</p><p>&nbsp; &nbsp; join ?.sys.indexes as b on a.object_id=b.object_id and a.index_id=b.index_id&nbsp;</p><p>&nbsp; &nbsp; join ?.sys.tables as c on a.object_id=c.object_id&nbsp;</p><p>&nbsp; &nbsp; join sys.databases as d on a.database_id=d.database_id</p><p>&nbsp; &nbsp; join ?.sys.schemas as e on c.schema_id=e.schema_id</p><p>&nbsp; &nbsp; join ?.sys.sysobjects f on c.object_id=f.id</p><p>&nbsp; &nbsp; join ?.sys.all_columns g on f.id=g.object_id</p><p>&nbsp; &nbsp; join ?.sys.types h on g.user_type_id=h.user_type_id</p><p>&nbsp; &nbsp; where a.avg_fragmentation_in_percent &gt;20</p><p>&nbsp; &nbsp; &nbsp;and c.type=&#39;&#39;U&#39;&#39; and f.xtype=&#39;&#39;U&#39;&#39;&nbsp;</p><p>&nbsp; &nbsp; &nbsp;and c.is_ms_shipped=0 &#39;</p><p>&nbsp; &nbsp; &nbsp;</p><p>&nbsp;DECLARE frg_cur CURSOR FOR</p><p>&nbsp; SELECT dbname,tablename,indexname,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;schemaname,avgfragment&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp;FROM #tmp&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp;WHERE NOT EXISTS (SELECT 1 FROM #tmp_sub b WHERE database_id=b.database_id AND tablename=b.tablename AND type_desc=b.index_type_desc)</p><p>&nbsp; &nbsp;&nbsp;</p><p>&nbsp; OPEN frg_cur</p><p>&nbsp; FETCH NEXT FROM &nbsp;frg_cur INTO @Db_name,@TableName,@IndexName,@SchemaName,@PctFrag</p><p>&nbsp; WHILE @@FETCH_STATUS=0</p><p>&nbsp; &nbsp;BEGIN</p><p>&nbsp; &nbsp; IF @PctFrag BETWEEN 20.0 AND 40.0</p><p>&nbsp; &nbsp; &nbsp;BEGIN</p><p>&nbsp; &nbsp; &nbsp; SET @Defrag=N&#39; ALTER INDEX &#39;+@IndexName+&#39; ON &#39;+@Db_name+&#39;.&#39;+@SchemaName+&#39;.&#39;+ @TableName +&#39; REORGANIZE&#39;--重新组织索引页不删除索引</p><p>&nbsp; &nbsp; &nbsp; EXEC SP_EXECUTESQL @Defrag</p><p>&nbsp; &nbsp; &nbsp;END</p><p>&nbsp; &nbsp; &nbsp;ELSE IF @PctFrag&gt;40.0</p><p>&nbsp; &nbsp; &nbsp;BEGIN</p><p>&nbsp; &nbsp; &nbsp; SET @Defrag=N&#39; ALTER INDEX &#39;+@IndexName+&#39; ON &#39;+@Db_name+&#39;.&#39;+@SchemaName+&#39;.&#39;+ @TableName +&#39; REBUILD WITH (ONLINE = ON )&#39;--联机重建索引。即不锁定表重新创建索引</p><p>&nbsp; &nbsp; &nbsp; EXEC SP_EXECUTESQL @Defrag</p><p>&nbsp; &nbsp; &nbsp;END</p><p>&nbsp; &nbsp; &nbsp;FETCH NEXT FROM &nbsp;frg_cur INTO @Db_name,@TableName,@IndexName,@SchemaName,@PctFrag</p><p>&nbsp; &nbsp;END</p><p>&nbsp; &nbsp;CLOSE frg_cur</p><p>&nbsp; &nbsp;DEALLOCATE frg_cur</p><p><br/></p><p>END</p><p><br/></p><p>SET NOCOUNT OFF</p><p><br/></p><p><br/></p><p><br/></p><p>GO</p><p>--=======================================</p><p>--用法</p><p>exec [dbo].[usp_auto_indexdefrag_online]</p><p><br/></p>