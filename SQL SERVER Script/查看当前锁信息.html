<p>USE [master]</p><p>GO</p><p>/****** Object: &nbsp;StoredProcedure [dbo].[p_lockinfo] &nbsp; &nbsp;Script Date: 02/07/2014 11:54:29 ******/</p><p>SET ANSI_NULLS ON</p><p>GO</p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p>ALTER PROC [dbo].[usp_lockinfo]</p><p>@kill_lock_spid BIT=0, &nbsp;--是否杀掉死锁的进程,1 杀掉, 0 仅显示</p><p>@show_spid_if_nolock BIT=1 --如果没有死锁的进程,是否显示正常进程信息,1 显示,0 不显示</p><p>AS</p><p>BEGIN</p><p>&nbsp; &nbsp; DECLARE @count INT,@s NVARCHAR(1000),@i INT</p><p>&nbsp; &nbsp; SELECT id=IDENTITY(INT,1,1),标志,</p><p>&nbsp; &nbsp; &nbsp;进程ID=SPID,线程ID=kpid,块进程ID=blocked,数据库ID=dbid,</p><p>&nbsp; &nbsp; &nbsp;数据库名=DB_NAME(dbid),用户ID=uid,用户名=loginame,累计CPU时间=cpu,</p><p>&nbsp; &nbsp; &nbsp;登陆时间=login_time,打开事务数=open_tran, 进程状态=status,</p><p>&nbsp; &nbsp; &nbsp;工作站名=hostname,应用程序名=program_name,工作站进程ID=hostprocess,</p><p>&nbsp; &nbsp; &nbsp;域名=nt_domain,网卡地址=net_address</p><p>&nbsp; &nbsp; INTO #t FROM(</p><p>&nbsp; &nbsp; &nbsp;SELECT 标志=&#39;死锁的进程&#39;,</p><p>&nbsp; &nbsp; &nbsp; SPID,kpid,a.blocked,dbid,uid,loginame,cpu,login_time,open_tran,</p><p>&nbsp; &nbsp; &nbsp; status,hostname,program_name,hostprocess,nt_domain,net_address,</p><p>&nbsp; &nbsp; &nbsp; s1=a.spid,s2=0</p><p>&nbsp; &nbsp; &nbsp;FROM master..sysprocesses a JOIN (</p><p>&nbsp; &nbsp; &nbsp; SELECT blocked FROM master..sysprocesses GROUP BY blocked</p><p>&nbsp; &nbsp; &nbsp; )b ON a.spid=b.blocked WHERE a.blocked=0</p><p>&nbsp; &nbsp; &nbsp;UNION ALL</p><p>&nbsp; &nbsp; &nbsp;SELECT &#39;|_牺牲品_&gt;&#39;,</p><p>&nbsp; &nbsp; &nbsp; SPID,kpid,blocked,dbid,uid,loginame,cpu,login_time,open_tran,</p><p>&nbsp; &nbsp; &nbsp; status,hostname,program_name,hostprocess,nt_domain,net_address,</p><p>&nbsp; &nbsp; &nbsp; s1=blocked,s2=1</p><p>&nbsp; &nbsp; &nbsp;FROM master..sysprocesses a WHERE blocked&lt;&gt;0</p><p>&nbsp; &nbsp; )a ORDER BY s1,s2</p><p><br/></p><p>&nbsp; &nbsp; SELECT @count=@@ROWCOUNT,@i=1</p><p><br/></p><p>&nbsp; &nbsp; IF @count=0 AND @show_spid_if_nolock=1</p><p>&nbsp; &nbsp; BEGIN</p><p>&nbsp; &nbsp; &nbsp;INSERT #t</p><p>&nbsp; &nbsp; &nbsp;SELECT 标志=&#39;正常的进程&#39;,</p><p>&nbsp; &nbsp; &nbsp; SPID,kpid,blocked,dbid,DB_NAME(dbid),uid,loginame,cpu,login_time,</p><p>&nbsp; &nbsp; &nbsp; open_tran,status,hostname,program_name,hostprocess,nt_domain,net_address</p><p>&nbsp; &nbsp; &nbsp;FROM master..sysprocesses</p><p>&nbsp; &nbsp; &nbsp;SET @count=@@ROWCOUNT</p><p>&nbsp; &nbsp; END</p><p><br/></p><p>&nbsp; &nbsp; IF @count&gt;0</p><p>&nbsp; &nbsp; BEGIN</p><p>&nbsp; &nbsp; &nbsp;CREATE TABLE #t1(id INT IDENTITY(1,1),a NVARCHAR(30),b INT,EventInfo NVARCHAR(MAX))</p><p>&nbsp; &nbsp; &nbsp;IF @kill_lock_spid=1</p><p>&nbsp; &nbsp; &nbsp;BEGIN</p><p>&nbsp; &nbsp; &nbsp; DECLARE @spid VARCHAR(10),@标志 VARCHAR(10)</p><p>&nbsp; &nbsp; &nbsp; WHILE @i&lt;=@count</p><p>&nbsp; &nbsp; &nbsp; BEGIN</p><p>&nbsp; &nbsp; &nbsp; &nbsp;SELECT @spid=进程ID,@标志=标志 FROM #t WHERE id=@i</p><p>&nbsp; &nbsp; &nbsp; &nbsp;INSERT #t1 EXEC(&#39;dbcc inputbuffer(&#39;+@spid+&#39;)&#39;)</p><p>&nbsp; &nbsp; &nbsp; &nbsp;IF @标志=&#39;死锁的进程&#39; EXEC(&#39;kill &#39;+@spid)</p><p>&nbsp; &nbsp; &nbsp; &nbsp;SET @i=@i+1</p><p>&nbsp; &nbsp; &nbsp; END</p><p>&nbsp; &nbsp; &nbsp;END</p><p>&nbsp; &nbsp; &nbsp;ELSE</p><p>&nbsp; &nbsp; &nbsp; WHILE @i&lt;=@count</p><p>&nbsp; &nbsp; &nbsp; BEGIN</p><p>&nbsp; &nbsp; &nbsp; &nbsp;SELECT @s=&#39;dbcc inputbuffer(&#39;+CAST(进程ID AS VARCHAR)+&#39;)&#39; FROM #t WHERE id=@i</p><p>&nbsp; &nbsp; &nbsp; &nbsp;INSERT #t1 EXEC(@s)</p><p>&nbsp; &nbsp; &nbsp; &nbsp;SET @i=@i+1</p><p>&nbsp; &nbsp; &nbsp; END</p><p>&nbsp; &nbsp; &nbsp;SELECT a.*,进程的SQL语句=b.EventInfo</p><p>&nbsp; &nbsp; &nbsp;FROM #t a JOIN #t1 b ON a.id=b.id</p><p>&nbsp; &nbsp; END</p><p>END</p><p>GO</p><p>--=====================================================</p><p>--Usage</p><p>EXEC [master].[dbo].[usp_lockinfo]</p><p>@kill_lock_spid=0, &nbsp;--是否杀掉死锁的进程,1 杀掉, 0 仅显示</p><p>@show_spid_if_nolock=1 --如果没有死锁的进程,是否显示正常进程信息,1 显示,0 不显示</p><p><br/></p>