<p><br/></p><p>场景:有三台服务器SQLNode12,SQLNode22 ,SQLNode32:</p><p>1) 三台服务器加入域DCDemo.com</p><p>2) 三台服务器使用端口访问数据库</p><p>3) 三台服务器构建故障转移群集SQLNode02</p><p>4) 三台服务器构建高可用性组N02_AG1</p><p>5) SQLNode12和SQLNode22实现自动故障转移</p><p>目标：实现对SQLNode12和SQLNode22的只读请求转移</p><p><br/></p><p>&nbsp;</p><p><br/></p><p>USE master</p><p>GO</p><p>ALTER AVAILABILITY GROUP [N02_AG1]</p><p>MODIFY REPLICA ON</p><p>N&#39;SQLNode12&#39; WITH</p><p>(SECONDARY_ROLE (ALLOW_CONNECTIONS = READ_ONLY));</p><p>GO</p><p>ALTER AVAILABILITY GROUP [N02_AG1]</p><p>&nbsp;MODIFY REPLICA ON</p><p>N&#39;SQLNode12&#39; WITH</p><p>(SECONDARY_ROLE (READ_ONLY_ROUTING_URL = N&#39;TCP://192.168.25.145:1433&#39;));</p><p>GO</p><p>ALTER AVAILABILITY GROUP [N02_AG1]</p><p>&nbsp;MODIFY REPLICA ON</p><p>N&#39;SQLNode22&#39; WITH</p><p>(SECONDARY_ROLE (ALLOW_CONNECTIONS = READ_ONLY));</p><p>GO</p><p>ALTER AVAILABILITY GROUP [N02_AG1]</p><p>&nbsp;MODIFY REPLICA ON</p><p>N&#39;SQLNode22&#39; WITH</p><p>(SECONDARY_ROLE (READ_ONLY_ROUTING_URL = N&#39;TCP://192.168.25.162:1433&#39;));</p><p>GO</p><p>ALTER AVAILABILITY GROUP [N02_AG1]</p><p>MODIFY REPLICA ON</p><p>N&#39;SQLNode12&#39; WITH</p><p>(PRIMARY_ROLE (READ_ONLY_ROUTING_LIST=(&#39;SQLNode22&#39;,&#39;SQLNode12&#39;)));</p><p>GO</p><p>ALTER AVAILABILITY GROUP [N02_AG1]</p><p>MODIFY REPLICA ON</p><p>N&#39;SQLNode22&#39; WITH</p><p>(PRIMARY_ROLE (READ_ONLY_ROUTING_LIST=(&#39;SQLNode12&#39;,&#39;SQLNode22&#39;)));</p><p>GO</p><p><br/></p><p><br/></p><p>验证：</p><p>SELECT</p><p>g.name AS AGName,</p><p>ar1.replica_server_name AS ReplicaServerName,</p><p>ar2.replica_server_name AS RountingReplicaServerName</p><p>FROM sys.availability_read_only_routing_lists rl</p><p>INNER JOIN sys.availability_replicas ar1 ON ar1.replica_id=rl.replica_id</p><p>INNER JOIN sys.availability_replicas ar2 ON ar2.replica_id=rl.read_only_replica_id</p><p>INNER JOIN sys.availability_groups g ON ar1.group_id=g.group_id</p><p>WHERE rl.routing_priority=1</p><p><br/></p>