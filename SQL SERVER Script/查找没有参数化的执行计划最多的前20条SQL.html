<p>--==============================================================</p><p>--查找没有参数化的执行计划最多的前20条SQL</p><p>SELECT &nbsp;*</p><p>FROM &nbsp; &nbsp;( SELECT TOP ( 20 )</p><p>qs.query_hash ,</p><p>COUNT(1) AS PlanCount ,</p><p>SUM(qs.execution_count) AS ExecCount</p><p>FROM &nbsp; &nbsp; &nbsp;SYS.dm_exec_query_stats AS qs</p><p>WHERE &nbsp; &nbsp; execution_count &lt; 10</p><p>GROUP BY &nbsp;query_hash</p><p>ORDER BY &nbsp;COUNT(1) DESC</p><p>) AS T1</p><p>CROSS APPLY ( SELECT TOP ( 1)</p><p>qs.last_execution_time ,</p><p>qs.creation_time ,</p><p>SUBSTRING(qt.text,</p><p>( qs.statement_start_offset / 2 )+ 1,</p><p>( ( CASE WHEN qs.statement_end_offset = -1</p><p>THEN LEN(CONVERT(NVARCHAR(MAX), qt.text))* 2</p><p>ELSE qs.statement_end_offset</p><p>END - qs.statement_start_offset )/ 2 ) + 1) AS IndividualQuery ,</p><p>qt.text AS ParentQuery ,</p><p>DB_NAME(qt.dbid) AS DatabaseName,</p><p>qp.query_plan AS QueryPlan</p><p>FROM &nbsp; &nbsp; &nbsp;sys.dm_exec_query_stats qs</p><p>CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle)</p><p>AS qt</p><p>CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp</p><p>WHERE &nbsp; &nbsp; QS.query_hash = T1.query_hash</p><p>ORDER BY &nbsp;qs.last_execution_time DESC</p><p>) AS T2</p><p><br/></p>