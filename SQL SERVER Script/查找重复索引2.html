<p></p><p>/*============================================================================</p><p>&nbsp; File: &nbsp; &nbsp; sp_SQLskills_SQL2008_finddupes_helpindex.sql</p><p><br/></p><p>&nbsp; Summary: &nbsp;This is similar to the rewrite of sp_helpindex but it requires</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that the included columns be unordered.</p><p><span class="Apple-tab-span" style="white-space:pre">					</span></p><p>&nbsp; Date: &nbsp; &nbsp; July 2011</p><p><br/></p><p>&nbsp; SQL Server 2008 Version</p><p>------------------------------------------------------------------------------</p><p>&nbsp; Written by Kimberly L. Tripp, SYSolutions, Inc.</p><p><br/></p><p>&nbsp; For more scripts and sample code, check out&nbsp;</p><p>&nbsp; &nbsp; http://www.SQLskills.com</p><p><br/></p><p>&nbsp; This script is intended only as a supplement to demos and lectures</p><p>&nbsp; given by SQLskills instructors. &nbsp;</p><p>&nbsp;&nbsp;</p><p>&nbsp; THIS CODE AND INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT WARRANTY OF&nbsp;</p><p>&nbsp; ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED&nbsp;</p><p>&nbsp; TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A</p><p>&nbsp; PARTICULAR PURPOSE.</p><p>============================================================================*/</p><p><br/></p><p>USE master</p><p>go</p><p><br/></p><p>if OBJECTPROPERTY(OBJECT_ID(&#39;sp_SQLskills_SQL2008_finddupes_helpindex&#39;), &#39;IsProcedure&#39;) = 1</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>drop procedure sp_SQLskills_SQL2008_finddupes_helpindex</p><p>go</p><p><br/></p><p>SET ANSI_NULLS ON</p><p>GO</p><p>SET QUOTED_IDENTIFIER ON</p><p>GO</p><p><br/></p><p>CREATE PROCEDURE [dbo].[sp_SQLskills_SQL2008_finddupes_helpindex]</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>@objname nvarchar(776)<span class="Apple-tab-span" style="white-space:pre">		</span>-- the table to check for indexes</p><p>as</p><p><br/></p><p>--November 2010: Added a column to show if an index is disabled.</p><p>-- &nbsp; &nbsp; May 2010: Added tree/leaf columns to the output - this requires the&nbsp;</p><p>-- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stored procedure: sp_SQLskills_ExposeColsInIndexLevels</p><p>-- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (Better known as sp_helpindex8)</p><p>-- &nbsp; March 2010: Added index_id to the output (ordered by index_id as well)</p><p>-- &nbsp;August 2008: Fixed a bug (missing begin/end block) AND I found</p><p>-- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a few other issues that people hadn&#39;t noticed (yikes!)!</p><p>-- &nbsp; April 2008: Updated to add included columns to the output.&nbsp;</p><p><br/></p><p><br/></p><p>-- See my blog for updates and/or additional information</p><p>-- http://www.SQLskills.com/blogs/Kimberly (Kimberly L. Tripp)</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>set nocount on</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>declare @objid int,<span class="Apple-tab-span" style="white-space:pre">			</span>-- the object id of the table</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@indid smallint,<span class="Apple-tab-span" style="white-space:pre">	</span>-- the index id of an index</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@groupid int, &nbsp;<span class="Apple-tab-span" style="white-space:pre">		</span>-- the filegroup id of an index</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@indname sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@groupname sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@status int,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@keys nvarchar(2126),<span class="Apple-tab-span" style="white-space:pre">	</span>--Length (16*max_identifierLength)+(15*2)+(16*3)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@inc_columns<span class="Apple-tab-span" style="white-space:pre">	</span>nvarchar(max),</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@inc_Count<span class="Apple-tab-span" style="white-space:pre">		</span>smallint,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@loop_inc_Count<span class="Apple-tab-span" style="white-space:pre">		</span>smallint,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@dbname<span class="Apple-tab-span" style="white-space:pre">	</span>sysname,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@ignore_dup_key<span class="Apple-tab-span" style="white-space:pre">	</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_unique<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_hypothetical<span class="Apple-tab-span" style="white-space:pre">	</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_primary_key<span class="Apple-tab-span" style="white-space:pre">	</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_unique_key <span class="Apple-tab-span" style="white-space:pre">	</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_disabled &nbsp; &nbsp;bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@auto_created<span class="Apple-tab-span" style="white-space:pre">	</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@no_recompute<span class="Apple-tab-span" style="white-space:pre">	</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@filter_definition<span class="Apple-tab-span" style="white-space:pre">	</span>nvarchar(max),</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@ColsInTree nvarchar(2126),</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@ColsInLeaf nvarchar(max)</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Check to see that the object names are local to the current database.</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>select @dbname = parsename(@objname,3)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>if @dbname is null</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @dbname = db_name()</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>else if @dbname &lt;&gt; db_name()</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>raiserror(15250,-1,-1)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>return (1)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Check to see the the table exists and initialize @objid.</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>select @objid = object_id(@objname)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>if @objid is NULL</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>raiserror(15009,-1,-1,@objname,@dbname)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>return (1)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>end</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- OPEN CURSOR OVER INDEXES (skip stats: bug shiloh_51196)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>declare ms_crs_ind cursor local static for</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select i.index_id, i.data_space_id, QUOTENAME(i.name, N&#39;]&#39;) AS name,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>i.ignore_dup_key, i.is_unique, i.is_hypothetical, i.is_primary_key, i.is_unique_constraint,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>s.auto_created, s.no_recompute, i.filter_definition, i.is_disabled</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>from sys.indexes as i&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>join sys.stats as s</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>on i.object_id = s.object_id&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>and i.index_id = s.stats_id</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>where i.object_id = @objid</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>open ms_crs_ind</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>fetch ms_crs_ind into @indid, @groupid, @indname, @ignore_dup_key, @is_unique, @is_hypothetical,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_primary_key, @is_unique_key, @auto_created, @no_recompute, @filter_definition, @is_disabled</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- IF NO INDEX, QUIT</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>if @@fetch_status &lt; 0</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>deallocate ms_crs_ind</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>--raiserror(15472,-1,-1,@objname) -- Object does not have any indexes.</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>return (0)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>end</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- create temp tables</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>CREATE TABLE #spindtab</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>(</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>index_name<span class="Apple-tab-span" style="white-space:pre">			</span>sysname<span class="Apple-tab-span" style="white-space:pre">	</span>collate database_default NOT NULL,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>index_id<span class="Apple-tab-span" style="white-space:pre">			</span>int,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>ignore_dup_key<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>is_unique<span class="Apple-tab-span" style="white-space:pre">			</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>is_hypothetical<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>is_primary_key<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>is_unique_key<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>is_disabled &nbsp; &nbsp; &nbsp; &nbsp; bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>auto_created<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>no_recompute<span class="Apple-tab-span" style="white-space:pre">		</span>bit,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>groupname<span class="Apple-tab-span" style="white-space:pre">			</span>sysname collate database_default NULL,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>index_keys<span class="Apple-tab-span" style="white-space:pre">			</span>nvarchar(2126)<span class="Apple-tab-span" style="white-space:pre">	</span>collate database_default NOT NULL, -- see @keys above for length descr</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>filter_definition<span class="Apple-tab-span" style="white-space:pre">	</span>nvarchar(max),</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>inc_Count<span class="Apple-tab-span" style="white-space:pre">			</span>smallint,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>inc_columns<span class="Apple-tab-span" style="white-space:pre">			</span>nvarchar(max),</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>cols_in_tree<span class="Apple-tab-span" style="white-space:pre">		</span>nvarchar(2126),</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>cols_in_leaf<span class="Apple-tab-span" style="white-space:pre">		</span>nvarchar(max)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>)</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>CREATE TABLE #IncludedColumns</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>(<span class="Apple-tab-span" style="white-space:pre">	</span>RowNumber<span class="Apple-tab-span" style="white-space:pre">	</span>smallint,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>[Name]<span class="Apple-tab-span" style="white-space:pre">	</span>nvarchar(128)</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>)</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- Now check out each index, figure out its type and keys and</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>--<span class="Apple-tab-span" style="white-space:pre">	</span>save the info in a temporary table that we&#39;ll print out at the end.</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>while @@fetch_status &gt;= 0</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- First we&#39;ll figure out what the keys are.</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>declare @i int, @thiskey nvarchar(131) -- 128+3</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @keys = QUOTENAME(index_col(@objname, @indid, 1), N&#39;]&#39;), @i = 2</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>if (indexkey_property(@objid, @indid, 1, &#39;isdescending&#39;) = 1)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @keys = @keys &nbsp;+ &#39;(-)&#39;</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @thiskey = QUOTENAME(index_col(@objname, @indid, @i), N&#39;]&#39;)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>if ((@thiskey is not null) and (indexkey_property(@objid, @indid, @i, &#39;isdescending&#39;) = 1))</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @thiskey = @thiskey + &#39;(-)&#39;</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>while (@thiskey is not null )</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>begin</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @keys = @keys + &#39;, &#39; + @thiskey, @i = @i + 1</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>select @thiskey = QUOTENAME(index_col(@objname, @indid, @i), N&#39;]&#39;)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>if ((@thiskey is not null) and (indexkey_property(@objid, @indid, @i, &#39;isdescending&#39;) = 1))</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>select @thiskey = @thiskey + &#39;(-)&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>end</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- Second, we&#39;ll figure out what the included columns are.</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @inc_columns = NULL</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>SELECT @inc_Count = count(*)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>FROM sys.tables AS tbl</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>INNER JOIN sys.indexes AS si&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>ON (si.index_id &gt; 0&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>and si.is_hypothetical = 0)&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>AND (si.object_id=tbl.object_id)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>INNER JOIN sys.index_columns AS ic&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>ON (ic.column_id &gt; 0&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>and (ic.key_ordinal &gt; 0 or ic.partition_ordinal = 0 or ic.is_included_column != 0))&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>AND (ic.index_id=CAST(si.index_id AS int) AND ic.object_id=si.object_id)</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>INNER JOIN sys.columns AS clmns&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>ON clmns.object_id = ic.object_id&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>and clmns.column_id = ic.column_id</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>WHERE ic.is_included_column = 1 and</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>(si.index_id = @indid) and&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>(tbl.object_id= @objid)</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @inc_Count &gt; 0</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>BEGIN</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>DELETE FROM #IncludedColumns</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>INSERT #IncludedColumns</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>SELECT ROW_NUMBER() OVER (ORDER BY clmns.column_id)&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>, clmns.name&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>FROM</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>sys.tables AS tbl</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>INNER JOIN sys.indexes AS si&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>ON (si.index_id &gt; 0&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">						</span>and si.is_hypothetical = 0)&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">						</span>AND (si.object_id=tbl.object_id)</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>INNER JOIN sys.index_columns AS ic&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>ON (ic.column_id &gt; 0&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">						</span>and (ic.key_ordinal &gt; 0 or ic.partition_ordinal = 0 or ic.is_included_column != 0))&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">						</span>AND (ic.index_id=CAST(si.index_id AS int) AND ic.object_id=si.object_id)</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>INNER JOIN sys.columns AS clmns&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>ON clmns.object_id = ic.object_id&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>and clmns.column_id = ic.column_id</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>WHERE ic.is_included_column = 1 and</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>(si.index_id = @indid) and&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>(tbl.object_id= @objid)</p><p><span class="Apple-tab-span" style="white-space:pre">			</span></p><p><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT @inc_columns = QUOTENAME([Name], N&#39;]&#39;) FROM #IncludedColumns WHERE RowNumber = 1</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">			</span>SET @loop_inc_Count = 1</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">			</span>WHILE @loop_inc_Count &lt; @inc_Count</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>BEGIN</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>SELECT @inc_columns = @inc_columns + &#39;, &#39; + QUOTENAME([Name], N&#39;]&#39;)&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>FROM #IncludedColumns WHERE RowNumber = @loop_inc_Count + 1</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>SET @loop_inc_Count = @loop_inc_Count + 1</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>END</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>END</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @groupname = null</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>select @groupname = name from sys.data_spaces where data_space_id = @groupid</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- Get the column list for the tree and leaf level, for all nonclustered indexes IF the table has a clustered index</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @indid = 1 AND (SELECT is_unique FROM sys.indexes WHERE index_id = 1 AND object_id = @objid) = 0</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT @ColsInTree = @keys + N&#39;, UNIQUIFIER&#39;, @ColsInLeaf = N&#39;All columns &quot;included&quot; - the leaf level IS the data row, plus the UNIQUIFIER&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @indid = 1 AND (SELECT is_unique FROM sys.indexes WHERE index_id = 1 AND object_id = @objid) = 1</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT @ColsInTree = @keys, @ColsInLeaf = N&#39;All columns &quot;included&quot; - the leaf level IS the data row.&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @indid &gt; 1 AND (SELECT COUNT(*) FROM sys.indexes WHERE index_id = 1 AND object_id = @objid) = 1</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>exec sp_SQLskills_ExposeColsInIndexLevels_INCLUDE_UNORDERED @objid, @indid, @ColsInTree OUTPUT, @ColsInLeaf OUTPUT</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @indid &gt; 1 AND @is_unique = 0 AND (SELECT is_unique FROM sys.indexes WHERE index_id = 1 AND object_id = @objid) = 0&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT @ColsInTree = @ColsInTree + N&#39;, UNIQUIFIER&#39;, @ColsInLeaf = @ColsInLeaf + N&#39;, UNIQUIFIER&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @indid &gt; 1 AND @is_unique = 1 AND (SELECT is_unique FROM sys.indexes WHERE index_id = 1 AND object_id = @objid) = 0&nbsp;</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT @ColsInLeaf = @ColsInLeaf + N&#39;, UNIQUIFIER&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>IF @indid &gt; 1 AND (SELECT COUNT(*) FROM sys.indexes WHERE index_id = 1 AND object_id = @objid) = 0 -- table is a HEAP</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>BEGIN</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>IF (@is_unique_key = 0)</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>SELECT @ColsInTree = @keys + N&#39;, RID&#39;</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>, @ColsInLeaf = @keys + N&#39;, RID&#39; + CASE WHEN @inc_columns IS NOT NULL THEN N&#39;, &#39; + @inc_columns ELSE N&#39;&#39; END</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">			</span>IF (@is_unique_key = 1)</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>SELECT @ColsInTree = @keys</p><p><span class="Apple-tab-span" style="white-space:pre">					</span>, @ColsInLeaf = @keys + N&#39;, RID&#39; + CASE WHEN @inc_columns IS NOT NULL THEN N&#39;, &#39; + @inc_columns ELSE N&#39;&#39; END</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>END</p><p><span class="Apple-tab-span" style="white-space:pre">			</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- INSERT ROW FOR INDEX</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>insert into #spindtab values (@indname, @indid, @ignore_dup_key, @is_unique, @is_hypothetical,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_primary_key, @is_unique_key, @is_disabled, @auto_created, @no_recompute, @groupname, @keys, @filter_definition, @inc_Count, @inc_columns, @ColsInTree, @ColsInLeaf)</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">		</span>-- Next index</p><p>&nbsp; &nbsp; <span class="Apple-tab-span" style="white-space:pre">	</span>fetch ms_crs_ind into @indid, @groupid, @indname, @ignore_dup_key, @is_unique, @is_hypothetical,</p><p><span class="Apple-tab-span" style="white-space:pre">			</span>@is_primary_key, @is_unique_key, @auto_created, @no_recompute, @filter_definition, @is_disabled</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>end</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>deallocate ms_crs_ind</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>-- DISPLAY THE RESULTS</p><p><span class="Apple-tab-span" style="white-space:pre">	</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>select</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;index_id&#39; = index_id,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;is_disabled&#39; = is_disabled,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;index_name&#39; = index_name,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;index_description&#39; = convert(varchar(210), --bits 16 off, 1, 2, 16777216 on, located on group</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>case when index_id = 1 then &#39;clustered&#39; else &#39;nonclustered&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when ignore_dup_key &lt;&gt;0 then &#39;, ignore duplicate keys&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when is_unique=1 then &#39;, unique&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when is_hypothetical &lt;&gt;0 then &#39;, hypothetical&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when is_primary_key &lt;&gt;0 then &#39;, primary key&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when is_unique_key &lt;&gt;0 then &#39;, unique key&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when auto_created &lt;&gt;0 then &#39;, auto create&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ case when no_recompute &lt;&gt;0 then &#39;, stats no recompute&#39; else &#39;&#39; end</p><p><span class="Apple-tab-span" style="white-space:pre">				</span>+ &#39; located on &#39; + groupname),</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;index_keys&#39; = index_keys,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;included_columns&#39; = inc_columns,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;filter_definition&#39; = filter_definition,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;columns_in_tree&#39; = cols_in_tree,</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>&#39;columns_in_leaf&#39; = cols_in_leaf</p><p><span class="Apple-tab-span" style="white-space:pre">		</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>from #spindtab</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>order by index_id</p><p><br/></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>return (0) -- sp_SQLskills_SQL2008_finddupes_helpindex</p><p>go</p><p><br/></p><p>exec sys.sp_MS_marksystemobject &#39;sp_SQLskills_SQL2008_finddupes_helpindex&#39;</p><p>go</p>