<p></p><p>--============================================================================</p><p>--查看当前实例下各数据库数据文件中可收缩情况</p><p>--UnusedExtents 标示可以被shrink的分区数</p><p>IF(OBJECT_ID(&#39;tempdb..#T&#39;) IS NOT NULL)</p><p>BEGIN</p><p>DROP TABLE #T</p><p>END</p><p>GO&nbsp;</p><p>IF(OBJECT_ID(&#39;tempdb..#T1&#39;) IS NOT NULL)</p><p>BEGIN</p><p>DROP TABLE #T1</p><p>END</p><p>GO</p><p>CREATE &nbsp;TABLE #T</p><p>(</p><p>&nbsp; &nbsp; DatabaseID INT,</p><p>&nbsp; &nbsp; FileID INT,</p><p>&nbsp; &nbsp; FileGroup INT,</p><p>&nbsp; &nbsp; TotalExtents INT,</p><p>&nbsp; &nbsp; UsedExtents INT,</p><p>&nbsp; &nbsp; LogicName NVARCHAR(200),</p><p>&nbsp; &nbsp; FilePath NVARCHAR(500)</p><p>)</p><p><br/></p><p>CREATE &nbsp;TABLE #T1</p><p>(</p><p>&nbsp; &nbsp; FileID INT,</p><p>&nbsp; &nbsp; FileGroup INT,</p><p>&nbsp; &nbsp; TotalExtents INT,</p><p>&nbsp; &nbsp; UsedExtents INT,</p><p>&nbsp; &nbsp; LogicName NVARCHAR(200),</p><p>&nbsp; &nbsp; FilePath NVARCHAR(500)</p><p>)</p><p><br/></p><p>EXEC sp_MSforeachdb N&#39;</p><p>USE [?]</p><p>DELETE FROM &nbsp;#T1</p><p>INSERT INTO &nbsp;#T1(FileID,FileGroup,TotalExtents,UsedExtents,LogicName,FilePath)</p><p>EXEC(&#39;&#39;DBCC SHOWFILESTATS&#39;&#39;)</p><p><br/></p><p>INSERT INTO &nbsp;#T(DatabaseID,FileID,FileGroup,TotalExtents,UsedExtents,LogicName,FilePath)</p><p>SELECT DB_ID(),FileID,FileGroup,TotalExtents,UsedExtents,LogicName,FilePath FROM #T1</p><p>&#39;</p><p><br/></p><p>SELECT DB_NAME(T.DatabaseID) AS DatabaseName,</p><p>(T.TotalExtents-T.UsedExtents) AS UnusedExtents,</p><p>* FROM #T AS T</p><p>ORDER BY UnusedExtents DESC</p><p>--============================================================================</p>