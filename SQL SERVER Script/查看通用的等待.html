<p>WITH [Waits] AS</p><p>&nbsp; &nbsp; (SELECT</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [wait_type],</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [wait_time_ms] / 1000.0 AS [WaitS],</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ([wait_time_ms] - [signal_wait_time_ms]) / 1000.0 AS [ResourceS],</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [signal_wait_time_ms] / 1000.0 AS [SignalS],</p><p>&nbsp; &nbsp; &nbsp; &nbsp; [waiting_tasks_count] AS [WaitCount],</p><p>&nbsp; &nbsp; &nbsp; &nbsp; 100.0 * [wait_time_ms] / SUM ([wait_time_ms]) OVER() AS [Percentage],</p><p>&nbsp; &nbsp; &nbsp; &nbsp; ROW_NUMBER() OVER(ORDER BY [wait_time_ms] DESC) AS [RowNum]</p><p>&nbsp; &nbsp; FROM sys.dm_os_wait_stats</p><p>&nbsp; &nbsp; WHERE [wait_type] NOT IN (</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;CLR_SEMAPHORE&#39;, &nbsp; &nbsp;N&#39;LAZYWRITER_SLEEP&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;RESOURCE_QUEUE&#39;, &nbsp; N&#39;SQLTRACE_BUFFER_FLUSH&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;SLEEP_TASK&#39;, &nbsp; &nbsp; &nbsp; N&#39;SLEEP_SYSTEMTASK&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;WAITFOR&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N&#39;HADR_FILESTREAM_IOMGR_IOCOMPLETION&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;CHECKPOINT_QUEUE&#39;, N&#39;REQUEST_FOR_DEADLOCK_SEARCH&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;XE_TIMER_EVENT&#39;, &nbsp; N&#39;XE_DISPATCHER_JOIN&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;LOGMGR_QUEUE&#39;, &nbsp; &nbsp; N&#39;FT_IFTS_SCHEDULER_IDLE_WAIT&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;BROKER_TASK_STOP&#39;, N&#39;CLR_MANUAL_EVENT&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;CLR_AUTO_EVENT&#39;, &nbsp; N&#39;DISPATCHER_QUEUE_SEMAPHORE&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;TRACEWRITE&#39;, &nbsp; &nbsp; &nbsp; N&#39;XE_DISPATCHER_WAIT&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;BROKER_TO_FLUSH&#39;, &nbsp;N&#39;BROKER_EVENTHANDLER&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;FT_IFTSHC_MUTEX&#39;, &nbsp;N&#39;SQLTRACE_INCREMENTAL_FLUSH_SLEEP&#39;,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; N&#39;DIRTY_PAGE_POLL&#39;, &nbsp;N&#39;SP_SERVER_DIAGNOSTICS_SLEEP&#39;)</p><p>&nbsp; &nbsp; )</p><p>SELECT</p><p>&nbsp; &nbsp; [W1].[wait_type] AS [WaitType],</p><p>&nbsp; &nbsp; CAST ([W1].[WaitS] AS DECIMAL(14, 2)) AS [Wait_S],</p><p>&nbsp; &nbsp; CAST ([W1].[ResourceS] AS DECIMAL(14, 2)) AS [Resource_S],</p><p>&nbsp; &nbsp; CAST ([W1].[SignalS] AS DECIMAL(14, 2)) AS [Signal_S],</p><p>&nbsp; &nbsp; [W1].[WaitCount] AS [WaitCount],</p><p>&nbsp; &nbsp; CAST ([W1].[Percentage] AS DECIMAL(4, 2)) AS [Percentage],</p><p>&nbsp; &nbsp; CAST (([W1].[WaitS] / [W1].[WaitCount]) AS DECIMAL (14, 4)) AS [AvgWait_S],</p><p>&nbsp; &nbsp; CAST (([W1].[ResourceS] / [W1].[WaitCount]) AS DECIMAL (14, 4)) AS [AvgRes_S],</p><p>&nbsp; &nbsp; CAST (([W1].[SignalS] / [W1].[WaitCount]) AS DECIMAL (14, 4)) AS [AvgSig_S]</p><p>FROM [Waits] AS [W1]</p><p>INNER JOIN [Waits] AS [W2]</p><p>&nbsp; &nbsp; ON [W2].[RowNum] &lt;= [W1].[RowNum]</p><p>GROUP BY [W1].[RowNum], [W1].[wait_type], [W1].[WaitS],</p><p>&nbsp; &nbsp; [W1].[ResourceS], [W1].[SignalS], [W1].[WaitCount], [W1].[Percentage]</p><p>HAVING SUM ([W2].[Percentage]) - [W1].[Percentage] &lt; 95; -- percentage threshold</p><p>GO</p><p><br/></p><pre><span style="color: rgb(0, 128, 128);"></span></pre><p>--=====================================================</p><p>--清除等待统计</p><p>DBCC SQLPERF (N&#39;sys.dm_os_wait_stats&#39;, CLEAR);</p><p>GO</p><pre><br/></pre>